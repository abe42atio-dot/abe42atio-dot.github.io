<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Pro Strategic Bubble & Video Planner</title>
<style>
  :root {
    --p1: #4facfe; --p2: #43e97b; --p3: #fa709a; --p4: #f6d365; --p5: #a18cd1;
    --bg: #f0f2f5;
  }
  body { font-family: 'Hiragino Sans', sans-serif; margin: 0; background: var(--bg); color: #333; }

  /* --- Dashboard --- */
  #dashboard { padding: 50px; text-align: center; }
  .project-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px; }
  .project-card { 
    background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
    cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.3s;
  }
  .project-card:hover { border-color: var(--p1); transform: translateY(-5px); }
  .delete-proj { position: absolute; top: 12px; right: 12px; color: #ddd; border: none; background: none; font-size: 20px; cursor: pointer; z-index: 5; }
  .delete-proj:hover { color: #ff4d4d; }
  .new-btn { background: linear-gradient(135deg, var(--p1), var(--p5)); color: #fff; border: none; padding: 14px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(79,172,254,0.4); }

  /* --- Editor --- */
  #editor { display: none; padding: 10px; }
  .page { width: 210mm; min-height: 297mm; background: #fff; padding: 10mm; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 15px; border-radius: 5px; position: relative; }

  .canvas-section { position: relative; height: 500px; background: #fcfdfe; border: 1px solid #eee; border-radius: 20px; overflow: hidden; }
  .center-line { position: absolute; left: 50%; top: 0; bottom: 0; border-left: 2px dashed #ddd; z-index: 1; }

  .parent-bubble {
    position: absolute; border-radius: 50%; border: 3px solid; 
    background: rgba(255,255,255,0.9); z-index: 10; cursor: grab;
    min-width: 150px; min-height: 150px; display: flex; align-items: center; justify-content: center;
  }
  .bubble-title { position: absolute; top: -22px; font-size: 11px; font-weight: bold; white-space: nowrap; }

  .child-container { position: absolute; display: flex; flex-direction: column; align-items: center; z-index: 20; }
  .child-label { font-size: 8px; font-weight: bold; color: #888; margin-bottom: 2px; outline: none; border-bottom: 1px dashed transparent; }
  .child-label:hover { border-bottom-color: #aaa; cursor: text; }
  .child-bubble {
    width: 55px; height: 55px; border-radius: 50%; background: #fff; border: 1.5px solid #ddd;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08); cursor: move; display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .child-text { font-size: 9px; width: 85%; text-align: center; border: none; outline: none; background: transparent; font-weight: 500; }

  .resize-handle {
    position: absolute; right: 5px; bottom: 5px; width: 12px; height: 12px;
    background: #e2e8f0; border-radius: 50%; cursor: nwse-resize; z-index: 30; border: 1px solid #cbd5e0;
  }

  .quick-add-btn { position: absolute; bottom: 5px; right: 5px; width: 22px; height: 22px; background: #eee; border-radius: 50%; border: none; cursor: pointer; font-size: 16px; color: #666; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: 0.2s; }
  .quick-add-btn:hover { opacity: 1; background: #ddd; }

  .section-title { font-size: 11px; font-weight: bold; color: #444; border-left: 4px solid #333; padding-left: 8px; margin: 10px 0 5px; }
  table { width: 100%; border-collapse: separate; border-spacing: 2px; font-size: 9px; }
  th { background: #f8fafc; padding: 6px; border-radius: 4px; color: #64748b; font-weight: 600; text-align: center; }
  td { background: #fff; border: 1px solid #f1f5f9; padding: 5px; border-radius: 4px; outline: none; }

  .flow-container { display: flex; gap: 8px; }
  .flow-card { flex: 1; border-top: 5px solid #eee; background: #fff; padding: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
  .flow-input { font-size: 9px; min-height: 40px; margin-top: 5px; padding: 4px; outline: none; background: #f9fafb; border-radius: 6px; }

  #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 12px; opacity: 0; transition: 0.5s; z-index: 1000; }
  .save-btn { background: #333; color: #fff; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 12px; margin-left: 10px; }

  @media print { .no-print { display: none !important; } .page { box-shadow: none; margin: 0; } }
</style>
</head>
<body>

<div id="toast">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>

<div id="dashboard">
  <h1 style="font-weight: 900;">Video Strategy Canvas</h1>
  <button class="new-btn" onclick="createNewProject()">+ Create New Strategy</button>
  <div id="project-list" class="project-list"></div>
</div>

<div id="editor">
  <div class="no-print" style="max-width:210mm; margin:10px auto; display:flex; justify-content:space-between; align-items:center;">
    <button onclick="goBackToDashboard()" style="cursor:pointer; background:none; border:none; color:var(--p1); font-weight:bold;">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
    <div>
      <button class="save-btn" onclick="manualSave()">ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜</button>
      <button class="new-btn" onclick="window.print()" style="padding:10px 30px; font-size:12px; margin-left:10px;">PDFå‡ºåŠ›</button>
    </div>
  </div>

  <div class="page">
    <h1 id="editable-title" contenteditable="true" style="text-align:center; outline:none; margin:0; font-size:22px;">New Project</h1>

    <section class="canvas-section" id="canvas">
      <div class="center-line"></div>
      <div id="b-theme" class="parent-bubble" style="top:30px; left:50px; border-color:var(--p1);"><span class="bubble-title">èª²é¡Œåˆ†æ (THEME)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-theme')">+</button><div class="resize-handle"></div></div>
      <div id="b-idea" class="parent-bubble" style="top:320px; left:60px; border-color:var(--p3);"><span class="bubble-title">è§£æ±ºç­– (IDEA)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-idea')">+</button><div class="resize-handle"></div></div>
      <div id="b-action" class="parent-bubble" style="top:180px; left:160px; border-color:var(--p2);"><span class="bubble-title">æ¤œè¨¼ (ACTION)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-action')">+</button><div class="resize-handle"></div></div>
      <div id="b-story" class="parent-bubble" style="top:30px; right:50px; border-color:var(--p5);"><span class="bubble-title">å°å…¥ (STORY)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-story')">+</button><div class="resize-handle"></div></div>
      <div id="b-weapon" class="parent-bubble" style="top:320px; right:60px; border-color:var(--p4);"><span class="bubble-title">æ­¦å™¨ (WEAPON)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-weapon')">+</button><div class="resize-handle"></div></div>
      <div id="b-scheme" class="parent-bubble" style="top:180px; right:160px; border-color:var(--p2);"><span class="bubble-title">ã‚¹ã‚­ãƒ¼ãƒ  (SCHEME)</span><button class="quick-add-btn no-print" onclick="smartAdd('b-scheme')">+</button><div class="resize-handle"></div></div>
    </section>

    <section class="flow-container">
      <div class="flow-card" style="border-color:var(--p1)"><span style="font-size:10px; font-weight:bold;">â‘  ã‚¿ã‚¤ãƒˆãƒ«</span><div class="flow-input" contenteditable="true"></div></div>
      <div class="flow-card" style="border-color:var(--p5)"><span style="font-size:10px; font-weight:bold;">â‘¡ å°å…¥</span><div class="flow-input" contenteditable="true"></div></div>
      <div class="flow-card" style="border-color:var(--p1)"><span style="font-size:10px; font-weight:bold;">â‘¢ ç¾çŠ¶åˆ†æ</span><div class="flow-input" contenteditable="true"></div></div>
      <div class="flow-card" style="border-color:var(--p3)"><span style="font-size:10px; font-weight:bold;">â‘£ è§£æ±ºç­–</span><div class="flow-input" contenteditable="true"></div></div>
      <div class="flow-card" style="border-color:var(--p2)"><span style="font-size:10px; font-weight:bold;">â‘¤ æ¤œè¨¼</span><div class="flow-input" contenteditable="true"></div></div>
      <div class="flow-card" style="border-color:#333"><span style="font-size:10px; font-weight:bold;">â‘¥ ãƒ“ã‚¸ãƒ§ãƒ³</span><div class="flow-input" contenteditable="true"></div></div>
    </section>

    <section>
      <div class="section-title">ğŸ¬ å‹•ç”»åˆ¶ä½œå·¥ç¨‹è¡¨ (å…¨6è©±æ§‹æˆ)</div>
      <table>
        <thead><tr><th>è©±æ•°</th><th>ãƒ†ãƒ¼ãƒãƒ»æ’®å½±å†…å®¹</th><th>æ’®å½±æ™‚æœŸ</th><th>å ´æ‰€</th><th>å‡ºæ¼”è€…</th><th>æ©Ÿæ</th><th>å‚™è€ƒ</th></tr></thead>
        <tbody id="video-tbody"></tbody>
      </table>
    </section>

    <section>
      <div class="section-title">ğŸ“… å®Ÿè¡Œã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
      <table>
        <thead><tr><th style="width: 120px;">è¦ç´ </th><th>WHAT</th><th>WHO</th><th>WHEN</th><th>WHERE</th><th>WHY</th><th>HOW</th></tr></thead>
        <tbody id="task-tbody">
          <tr><td style="font-weight:bold; border-left:4px solid var(--p1);">â‘ ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td></tr>
          <tr><td style="font-weight:bold; border-left:4px solid var(--p4);">â‘¡ã‚¦ã‚¨ãƒãƒ³åˆ¶ä½œ</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td></tr>
          <tr><td style="font-weight:bold; border-left:4px solid var(--p2);">â‘¢ã‚¤ãƒ™ãƒ³ãƒˆ</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td></tr>
        </tbody>
      </table>
    </section>
  </div>
</div>

<script>
  let projects = JSON.parse(localStorage.getItem('bubbleVideoV10')) || [];
  let currentId = null;
  let activeElem = null;
  let resizeElem = null;
  let offset = { x: 0, y: 0 };

  const masterConfig = {
    'b-theme': ['ç¤¾ä¼šå•é¡Œ', 'èª²é¡Œ'],
    'b-action': ['ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼', 'ã‚¤ãƒ™ãƒ³ãƒˆ'],
    'b-idea': ['1', '2', '3'],
    'b-story': ['å¥½ããªãƒ¢ãƒ', 'çµŒé¨“', 'å¤¢'],
    'b-scheme': ['å”åŠ›è€…', 'ãƒ‘ãƒˆãƒ­ãƒ³', 'é¡§å®¢'],
    'b-weapon': ['ã‚¹ã‚­ãƒ«', 'ã‚µãƒ¼ãƒ“ã‚¹', 'ã‚¢ãƒ—ãƒª', 'å•†å“']
  };

  const vt = document.getElementById('video-tbody');
  for(let i=1; i<=6; i++) {
    vt.innerHTML += `<tr><td style="text-align:center; font-weight:bold;">ç¬¬ ${i} è©±</td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td></tr>`;
  }

  function createChildDOM(label, text = "", size = 55, x = 0, y = 0) {
    const container = document.createElement('div'); container.className = 'child-container';
    container.innerHTML = `<div class="child-label" contenteditable="true">${label}</div><div class="child-bubble" style="width:${size}px; height:${size}px;"><input class="child-text" value="${text}"><div class="resize-handle"></div></div>`;
    container.style.left = x + 'px'; container.style.top = y + 'px';
    container.oncontextmenu = (e) => { e.preventDefault(); container.remove(); save(); };
    container.onmousedown = (e) => {
      if(e.target.classList.contains('resize-handle')) { resizeElem = container.querySelector('.child-bubble'); e.stopPropagation(); return; }
      if(e.target.hasAttribute('contenteditable') || e.target.tagName === 'INPUT') return;
      activeElem = container; e.stopPropagation();
      const r = container.getBoundingClientRect(); offset.x = e.clientX - r.left; offset.y = e.clientY - r.top;
    };
    return container;
  }

  function smartAdd(parentId) {
    const pb = document.getElementById(parentId);
    const existingLabels = Array.from(pb.querySelectorAll('.child-label')).map(el => el.innerText);
    const defaults = masterConfig[parentId];
    const missingDefault = defaults.find(label => !existingLabels.includes(label));
    if (missingDefault) { spawnChild(parentId, missingDefault); } 
    else { spawnChild(parentId, 'æ–°ã—ã„é …ç›®'); }
  }

  function spawnChild(parentId, label, text="", x=null, y=null, size=55) {
    const pb = document.getElementById(parentId);
    const count = pb.querySelectorAll('.child-container').length;
    
    // é‡ãªã‚‰ãªã„é…ç½®ãƒ­ã‚¸ãƒƒã‚¯
    let posX, posY;
    if (x !== null && y !== null) {
      posX = x; posY = y;
    } else {
      const radius = 42; // è¦ªã®ä¸­å¿ƒã‹ã‚‰ã®è·é›¢
      const centerX = pb.offsetWidth / 2 - 27;
      const centerY = pb.offsetHeight / 2 - 27;
      // é‡ãªã‚‰ãªã„ã‚ˆã†ã«è§’åº¦ã‚’åˆ†æ•£ (æœ€å¤§8å€‹ç¨‹åº¦ã¾ã§æƒ³å®š)
      const angle = (count * 75) * (Math.PI / 180); 
      posX = centerX + radius * Math.cos(angle);
      posY = centerY + radius * Math.sin(angle);
    }

    pb.appendChild(createChildDOM(label, text, size, posX, posY));
    save();
  }

  document.onmousedown = (e) => {
    if(e.target.classList.contains('resize-handle')) { resizeElem = e.target.parentElement; e.stopPropagation(); return; }
    const pb = e.target.closest('.parent-bubble');
    if(pb && !e.target.classList.contains('quick-add-btn')) { 
      activeElem = pb; const r = pb.getBoundingClientRect(); offset.x = e.clientX - r.left; offset.y = e.clientY - r.top; 
    }
  };
  document.onmousemove = (e) => {
    if(resizeElem) {
      const rect = resizeElem.getBoundingClientRect();
      resizeElem.style.width = resizeElem.style.height = Math.max(40, e.clientX - rect.left) + 'px';
      return;
    }
    if(!activeElem) return;
    const canvas = document.getElementById('canvas').getBoundingClientRect();
    if(activeElem.classList.contains('child-container')) {
      const p = activeElem.parentElement.getBoundingClientRect();
      activeElem.style.left = (e.clientX - p.left - offset.x) + 'px';
      activeElem.style.top = (e.clientY - p.top - offset.y) + 'px';
    } else {
      activeElem.style.left = (e.clientX - canvas.left - offset.x) + 'px';
      activeElem.style.top = (e.clientY - canvas.top - offset.y) + 'px';
    }
  };
  document.onmouseup = () => { if(activeElem || resizeElem) save(); activeElem = null; resizeElem = null; };

  function save() {
    if(!currentId) return;
    const projectIndex = projects.findIndex(x => x.id === currentId);
    if(projectIndex === -1) return;
    const p = projects[projectIndex];
    p.title = document.getElementById('editable-title').innerText;
    p.bubbles = {};
    document.querySelectorAll('.parent-bubble').forEach(pb => {
      p.bubbles[pb.id] = {
        x: pb.style.left, y: pb.style.top, w: pb.style.width, h: pb.style.height,
        children: Array.from(pb.querySelectorAll('.child-container')).map(c => ({
          label: c.querySelector('.child-label').innerText,
          text: c.querySelector('.child-text').value,
          x: parseInt(c.style.left), y: parseInt(c.style.top),
          size: c.querySelector('.child-bubble').offsetWidth
        }))
      };
    });
    p.flow = Array.from(document.querySelectorAll('.flow-input')).map(i => i.innerText);
    p.video = Array.from(document.querySelectorAll('#video-tbody td[contenteditable]')).map(td => td.innerText);
    p.task = Array.from(document.querySelectorAll('#task-tbody td[contenteditable]')).map(td => td.innerText);
    localStorage.setItem('bubbleVideoV10', JSON.stringify(projects));
  }

  function manualSave() { save(); toast(); }
  function toast() { const t = document.getElementById('toast'); t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 1500); }

  function createNewProject() {
    const id = Date.now().toString();
    projects.push({ id, title: "æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", bubbles: {} });
    currentId = id;
    showEditor();
    document.getElementById('editable-title').innerText = "æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ";
    document.querySelectorAll('.child-container').forEach(c => c.remove());
    document.querySelectorAll('[contenteditable]').forEach(el => el.innerText = "");
    Object.keys(masterConfig).forEach(bid => {
      masterConfig[bid].forEach((label) => spawnChild(bid, label));
    });
    save();
  }

  function openProject(id) {
    currentId = id; const p = projects.find(x => x.id === id);
    if(!p) return;
    showEditor();
    document.getElementById('editable-title').innerText = p.title;
    document.querySelectorAll('.child-container').forEach(c => c.remove());
    Object.keys(p.bubbles || {}).forEach(bid => {
      const pb = document.getElementById(bid); const d = p.bubbles[bid];
      if(!pb || !d) return;
      pb.style.left = d.x; pb.style.top = d.y; pb.style.width = d.w; pb.style.height = d.h;
      (d.children || []).forEach(c => spawnChild(bid, c.label, c.text, c.x, c.y, c.size));
    });
    if(p.flow) document.querySelectorAll('.flow-input').forEach((el, i) => el.innerText = p.flow[i] || "");
    if(p.video) document.querySelectorAll('#video-tbody td[contenteditable]').forEach((el, i) => el.innerText = p.video[i] || "");
    if(p.task) document.querySelectorAll('#task-tbody td[contenteditable]').forEach((el, i) => el.innerText = p.task[i] || "");
  }

  function deleteProject(id, e) {
    e.stopPropagation(); if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    projects = projects.filter(p => p.id !== id);
    localStorage.setItem('bubbleVideoV10', JSON.stringify(projects));
    renderList();
  }

  function renderList() {
    const l = document.getElementById('project-list'); l.innerHTML = '';
    projects.forEach(p => {
      const card = document.createElement('div'); card.className = 'project-card';
      card.innerHTML = `<button class="delete-proj" onclick="deleteProject('${p.id}', event)">Ã—</button><h3>${p.title}</h3>`;
      card.onclick = () => openProject(p.id);
      l.appendChild(card);
    });
  }

  function goBackToDashboard() { save(); showDashboard(); }
  function showEditor() { document.getElementById('dashboard').style.display='none'; document.getElementById('editor').style.display='block'; }
  function showDashboard() { document.getElementById('dashboard').style.display='block'; document.getElementById('editor').style.display='none'; renderList(); }

  window.onload = renderList;
</script>
</body>
</html>
