<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projects Maker 1ki2</title>
<style>
  :root{
    --p1:#4facfe; --p2:#43e97b; --p3:#fa709a; --p4:#f6d365; --p5:#a18cd1;
    --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --bg:#ffffff; --paper:#ffffff; --soft:#f9fafb;

    /* Plan defaults (A4 fitting) */
    --planFont: 11px;
    --planLine: 1.45;

    /* â˜…è¿½åŠ ï¼šç”»åƒæ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé«˜ã• */
    --planImgBoxH: 120px;
  }

  body{
    font-family: "Hiragino Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    margin:0; background:var(--bg); color:var(--ink);
    touch-action: manipulation;
  }

  /* --- Dashboard --- */
  #dashboard{ padding:28px 16px; max-width: 1040px; margin:0 auto; }
  .dash-header{ text-align:center; margin-bottom:22px; }
  .dash-header h1{ margin:0 0 10px; font-weight:900; letter-spacing: .02em; }
  .dash-sub{ color:var(--muted); font-size:12px; margin-bottom:14px; }
  .add-btn-main{
    background:#111827; color:#fff; border:none; padding:12px 18px; border-radius:999px;
    font-weight:800; cursor:pointer; font-size:14px;
  }

  .folder-container{
    background:var(--paper); border-radius:16px; margin-bottom:14px;
    box-shadow: 0 8px 30px rgba(17,24,39,0.06);
    overflow:hidden; border:1px solid var(--line); border-left: 10px solid var(--p1);
  }
  .folder-header{
    padding:14px 18px; display:flex; align-items:center; cursor:pointer;
    background: #fff; transition:.15s;
  }
  .folder-header:hover{ background: var(--soft); }
  .folder-icon{ font-size:22px; margin-right:10px; }
  .folder-name{ flex-grow:1; font-weight:900; font-size:16px; outline:none; }
  .folder-controls{ display:flex; align-items:center; gap:10px; }
  .color-picker{ width:24px; height:24px; border-radius:50%; border:2px solid #fff; box-shadow: 0 0 0 1px #ddd; cursor:pointer; padding:0; }
  .delete-item{ color:#b6b6b6; border:none; background:none; cursor:pointer; font-size:16px; }
  .delete-item:hover{ color:#ff4d4d; }

  .project-grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap:12px; padding:14px 16px; background:#fff; border-top: 1px solid var(--line);
  }
  .project-card{
    background: var(--soft); padding:14px; border-radius:14px; border:1px solid #e8edf4;
    cursor:pointer; position:relative; transition:.2s;
  }
  .project-card:hover{
    transform: translateY(-2px); border-color: rgba(79,172,254,.55); background:#fff;
    box-shadow: 0 10px 22px rgba(17,24,39,.06);
  }
  .add-project-in-folder{
    background:#fff; border:2px dashed #d1d5db; border-radius:14px;
    display:flex; align-items:center; justify-content:center; color:#6b7280;
    font-weight:900; cursor:pointer; min-height:80px;
  }

  /* --- Editor --- */
  #editor{ display:none; padding: 10px; }
  .topbar{
    max-width:210mm; margin: 10px auto; display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .back-btn{
    cursor:pointer; background:none; border:none; color:var(--p1); font-weight:900;
  }
  .save-btn{
    background:#111827; color:#fff; border:none; padding:10px 16px; border-radius:999px;
    font-weight:900; cursor:pointer; font-size:12px;
  }
  .save-btn.secondary{ background:#6b7280; }

  /* tabs */
  .tabbar{
    max-width:210mm; margin:0 auto 8px; display:flex; gap:8px; flex-wrap:wrap;
  }
  .tab{
    border:1px solid var(--line); background:#fff; color:#111827;
    padding:8px 12px; border-radius:999px; font-weight:900; cursor:pointer; font-size:12px;
  }
  .tab.active{ border-color: rgba(79,172,254,.65); box-shadow: 0 6px 16px rgba(79,172,254,.12); }

  .page{
    width: 210mm; min-height: 297mm; background: var(--paper);
    padding: 10mm; margin: 0 auto 12px;
    box-shadow: 0 0 50px rgba(0,0,0,0.10);
    display:flex; flex-direction:column; gap:14px;
    border-radius: 6px; position:relative; border: 1px solid var(--line);
  }
  .page-title{
    text-align:center; outline:none; margin:0; font-size:22px; font-weight:1000;
  }

  /* --- Canvas area --- */
  .canvas-section{ position:relative; height:500px; background:#fcfdfe; border:1px solid #eee; border-radius:20px; overflow:hidden; }
  .center-line{ position:absolute; left:50%; top:0; bottom:0; border-left:2px dashed #ddd; z-index:1; }

  .parent-bubble{
    position:absolute; border-radius:50%; border:3px solid;
    background: rgba(255,255,255,0.92); z-index:10; cursor:grab;
    min-width:150px; min-height:150px; display:flex; align-items:center; justify-content:center;
  }
  .bubble-title{ position:absolute; top:-22px; font-size:11px; font-weight:900; white-space:nowrap; }

  .child-container{ position:absolute; display:flex; flex-direction:column; align-items:center; z-index:20; transition: left .3s ease, top .3s ease; }
  .child-label-wrap{ display:flex; align-items:center; gap:4px; }
  .child-label{ font-size:8px; font-weight:900; color:#888; outline:none; border-bottom:1px dashed transparent; }
  .child-del-btn{ font-size:10px; color:#ccc; cursor:pointer; border:none; background:none; padding:0; line-height:1; }
  .child-del-btn:hover{ color:#ff4d4d; }

  .child-bubble{
    width:55px; height:55px; border-radius:50%; background:#fff; border:1.5px solid #ddd;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08); cursor:move; display:flex; align-items:center; justify-content:center; position:relative;
  }
  .child-text{ font-size:9px; width:85%; text-align:center; border:none; outline:none; background:transparent; font-weight:600; }

  .resize-handle{
    position:absolute; right:-8px; bottom:-8px; width:24px; height:24px;
    background:#fff; border:2px solid #cbd5e0; border-radius:50%;
    cursor:nwse-resize; z-index:30; display:flex; align-items:center; justify-content:center;
  }
  .resize-handle::after{ content:"â†˜"; font-size:12px; color:#666; }

  .quick-add-btn{
    position:absolute; bottom:-8px; left:-8px; width:24px; height:24px;
    background:#eee; border-radius:50%; border:2px solid #ddd; cursor:pointer;
    font-size:18px; color:#666; display:flex; align-items:center; justify-content:center;
    opacity:.85; transition:.2s; z-index:40;
  }

  .section-title{
    font-size:11px; font-weight:1000; color:#111827;
    border-left: 4px solid #111827; padding-left: 8px; margin: 8px 0 4px;
  }
  table{ width:100%; border-collapse:separate; border-spacing:2px; font-size:9px; }
  th{ background:#f8fafc; padding:6px; border-radius:4px; color:#64748b; font-weight:900; text-align:center; }
  td{ background:#fff; border:1px solid #f1f5f9; padding:5px; border-radius:4px; outline:none; }

  .flow-container{ display:flex; gap:8px; flex-wrap:wrap; }
  .flow-card{
    flex: 1; min-width: 140px;
    border-top: 5px solid #eee; background:#fff; padding:10px; border-radius:14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eef2f7;
  }
  .flow-input{ font-size:10px; min-height:40px; margin-top:6px; padding:6px; outline:none; background:#f9fafb; border-radius:10px; }

  /* --- Document blocks --- */
  .doc-area{
    border:1px solid #eef2f7; border-radius:14px; padding:10px;
    background:#fff;
  }
  .doc-area .hint{ font-size:11px; color:var(--muted); margin:0 0 8px; }
  .doc-line{
    font-size:12px; line-height:1.65;
    padding:2px 0;
    white-space:pre-wrap;
  }
  .doc-line[contenteditable="true"]:focus{
    outline: 2px solid rgba(79,172,254,.25);
    border-radius:8px;
  }
  .doc-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .mini-btn{
    border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:999px;
    font-weight:1000; cursor:pointer; font-size:12px;
  }
  .mini-btn.primary{ border-color: rgba(79,172,254,.55); box-shadow: 0 10px 20px rgba(79,172,254,.12); }

  /* --- Input Menubar (Plan/Pres) --- */
  .inputbar{
    border:1px solid var(--line); border-radius:14px; background:#fff;
    padding:10px; display:flex; align-items:center; justify-content:space-between;
    gap:10px; box-shadow: 0 6px 18px rgba(17,24,39,.04);
  }
  .inputbar .left{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .inputbar .title{
    font-size:12px; font-weight:1000; color:#111827;
  }
  .inputbar .desc{
    font-size:11px; color:var(--muted);
  }
  .inputbar .right{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .inputdrawer{
    margin-top:10px;
    border:1px solid #eef2f7; border-radius:14px; background:#fff;
    padding:10px;
    display:none;
  }
  .inputdrawer.open{ display:block; }
  .fields-grid{
    display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px;
  }
  .field{
    display:grid; grid-template-columns: 110px 1fr; gap:8px; align-items:center;
    padding:6px 0; border-bottom:1px dashed #eef2f7;
  }
  .field:last-child{ border-bottom:none; }
  .field label{ font-size:11px; color:var(--muted); font-weight:900; }
  .field input, .field textarea{
    width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;
    font-size:12px; outline:none; background:#fff;
  }
  .field textarea{ min-height:64px; resize:vertical; }

  /* --- Plan A4 Fit / Emphasis --- */
  #tab-plan{ padding: 8mm; }
  #tab-plan .doc-area{ padding: 8px; }
  /* â˜…line-height ã‚’ var(--planLine) ã«çµ±ä¸€ */
  #tab-plan .doc-line{ font-size: var(--planFont); line-height: var(--planLine); padding: 1px 0; }
  #tab-plan .plan-heading{
    font-weight:1000;
    font-size: calc(var(--planFont) + 1px);
    margin-top: 6px;
  }
  #tab-plan .plan-title{
    font-weight:1000;
    font-size: calc(var(--planFont) + 4px);
    letter-spacing: .02em;
    margin: 4px 0 8px;
  }
  #tab-plan .plan-bullet strong{ font-weight:1000; }

  .plan-images{
    display:grid; grid-template-columns: 1fr 1fr; gap:8px;
    margin-top:6px;
  }
  /* â˜…å¤‰æ›´ï¼šæ ã®é«˜ã•ã‚’å¯å¤‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ --planImgBoxHï¼‰ */
  .plan-images .imgbox{
    border:1px dashed #cbd5e1; border-radius:12px;
    height: var(--planImgBoxH);
    background:#f8fafc;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    position:relative;
  }
  .plan-images img{
    width:100%; height:100%; object-fit:cover; display:block;
    transform-origin:center center;
  }

  /* âœ… ç”»åƒæ“ä½œUI */
  .img-tools{
    position:absolute; left:8px; right:8px; bottom:8px;
    display:flex; flex-direction:column; gap:6px;
    background: rgba(255,255,255,.86);
    border:1px solid rgba(226,232,240,.9);
    border-radius:12px;
    padding:8px;
    backdrop-filter: blur(4px);
  }
  .img-tools .row{
    display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  }
  .img-tools .btn-mini{
    border:1px solid #e5e7eb; background:#fff; border-radius:999px;
    padding:6px 10px; font-weight:1000; font-size:11px; cursor:pointer;
  }
  .img-tools .btn-mini.danger{ border-color:#fecaca; color:#b91c1c; }
  .img-tools .lbl{
    font-size:11px; color:var(--muted); font-weight:900;
  }
  .img-tools input[type="range"]{ width: 140px; }

  .fontctl{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--line); border-radius:999px; padding:6px 10px;
    background:#fff;
  }
  .fontctl span{ font-size:11px; color:var(--muted); font-weight:900; }
  .fontctl input[type="range"]{ width: 110px; }

  /* --- Video script --- */
  .video-script-table td{ vertical-align:middle; }
  .status-select{
    width: 100%; border:1px solid #e5e7eb; border-radius:8px; padding:4px 6px; font-size:10px; outline:none; background:#fff;
  }
  .video-script-table{ font-size:12px; }
  .video-script-table th{ padding:10px 8px; }
  .video-script-table td{ padding:10px 8px; }
  .video-script-table td[contenteditable]{ line-height:1.6; min-height:34px; }

  .video-script-table tr[data-ep] td:first-child{ border-left: 8px solid #e5e7eb; }
  .video-script-table tr[data-ep="1"] td:first-child{ border-left-color: var(--p1); }
  .video-script-table tr[data-ep="2"] td:first-child{ border-left-color: var(--p5); }
  .video-script-table tr[data-ep="3"] td:first-child{ border-left-color: var(--p1); }
  .video-script-table tr[data-ep="4"] td:first-child{ border-left-color: var(--p3); }
  .video-script-table tr[data-ep="5"] td:first-child{ border-left-color: var(--p2); }
  .video-script-table tr[data-ep="6"] td:first-child{ border-left-color: #111827; }

  .video-script-table tr[data-ep-start="true"] td{
    border-top: 2px solid #cbd5e1;
    background:#f8fafc;
  }
  .video-script-table tr[data-ep="1"][data-ep-start="true"] td{ background:#f0f9ff; }
  .video-script-table tr[data-ep="2"][data-ep-start="true"] td{ background:#f6f3ff; }
  .video-script-table tr[data-ep="3"][data-ep-start="true"] td{ background:#f0f9ff; }
  .video-script-table tr[data-ep="4"][data-ep-start="true"] td{ background:#fff1f2; }
  .video-script-table tr[data-ep="5"][data-ep-start="true"] td{ background:#f0fdf4; }
  .video-script-table tr[data-ep="6"][data-ep-start="true"] td{ background:#f3f4f6; }

  #toast{
    position:fixed; bottom:20px; right:20px; background:#111827; color:#fff;
    padding:10px 16px; border-radius:999px; font-size:12px; opacity:0; transition:.5s; z-index:1000;
  }

  @media (max-width: 780px){
    #dashboard{ padding:18px 12px; }
    .page{ width: calc(100vw - 16px); min-height:auto; padding:14px; border-radius:16px; }
    .topbar, .tabbar{ max-width: calc(100vw - 16px); }
    .canvas-section{ height: 520px; }
    .fields-grid{ grid-template-columns: 1fr; }
    #tab-plan{ padding:14px; }
    .plan-images{ grid-template-columns: 1fr; }
    .img-tools input[type="range"]{ width: 180px; }
  }

  @media print{
    body{ background:#fff; }
    .no-print{ display:none !important; }
    .page{ box-shadow:none; margin:0; border:none; border-radius:0; }
    .tab-content{ display:block !important; }

    body.print-single .tab-content{ display:none !important; }
    body.print-single #tab-plan{ display:block !important; }
    body.print-single #tab-pres{ display:none !important; }
    body.print-single #tab-video{ display:none !important; }
    body.print-single #tab-canvas{ display:none !important; }
  }
</style>
</head>

<body>
<div id="toast">ä¿å­˜ã—ã¾ã—ãŸ âœ…</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dash-header">
    <h1>ğŸ“ Projects Maker 1ki2</h1>
    <div class="dash-sub">ãƒ•ã‚©ãƒ«ãƒ€ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ â†’ 4ã¤ã®ã‚¿ãƒ–ï¼ˆğŸ«§ã‚­ãƒ£ãƒ³ãƒã‚¹ / ğŸ“„ä¼ç”»æ›¸ / ğŸ¤ãƒ—ãƒ¬ã‚¼ãƒ³ / ğŸ¬å‹•ç”»å°æœ¬ï¼‰</div>
    <button class="add-btn-main" onclick="createNewFolder()">ğŸ“ æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</button>
  </div>
  <div id="folder-list"></div>
</div>

<!-- Editor -->
<div id="editor">
  <div class="topbar no-print">
    <button class="back-btn" onclick="goBackToDashboard()">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹</button>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="save-btn" onclick="manualSave()">ğŸ’¾ ä¿å­˜</button>
      <button class="save-btn secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ· / PDF</button>
      <button class="save-btn secondary" onclick="printPlanOnly()">ğŸ–¨ï¸ ä¼ç”»æ›¸ã ã‘å°åˆ·</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabbar no-print">
    <button class="tab active" data-tab="tab-canvas" onclick="switchTab('tab-canvas', this)">ğŸ«§ ã‚­ãƒ£ãƒ³ãƒã‚¹</button>
    <button class="tab" data-tab="tab-plan" onclick="switchTab('tab-plan', this)">ğŸ“„ ä¼ç”»æ›¸</button>
    <button class="tab" data-tab="tab-pres" onclick="switchTab('tab-pres', this)">ğŸ¤ ãƒ—ãƒ¬ã‚¼ãƒ³å°æœ¬</button>
    <button class="tab" data-tab="tab-video" onclick="switchTab('tab-video', this)">ğŸ¬ å‹•ç”»å°æœ¬</button>
  </div>

  <!-- Page 1: Canvas -->
  <div class="page tab-content" id="tab-canvas" style="display:block;">
    <h1 id="editable-title" class="page-title" contenteditable="true">Project Name</h1>

    <section class="canvas-section" id="canvas">
      <div class="center-line"></div>

      <div id="b-theme" class="parent-bubble" style="top:30px; left:50px; border-color:var(--p1);">
        <span class="bubble-title">èª²é¡Œåˆ†æ (THEME)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-theme')">+</button>
        <div class="resize-handle"></div>
      </div>

      <div id="b-idea" class="parent-bubble" style="top:320px; left:60px; border-color:var(--p3);">
        <span class="bubble-title">è§£æ±ºç­– (IDEA)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-idea')">+</button>
        <div class="resize-handle"></div>
      </div>

      <div id="b-action" class="parent-bubble" style="top:180px; left:160px; border-color:var(--p2);">
        <span class="bubble-title">æ¤œè¨¼ (ACTION)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-action')">+</button>
        <div class="resize-handle"></div>
      </div>

      <div id="b-story" class="parent-bubble" style="top:30px; right:50px; border-color:var(--p5);">
        <span class="bubble-title">å°å…¥ (STORY)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-story')">+</button>
        <div class="resize-handle"></div>
      </div>

      <div id="b-weapon" class="parent-bubble" style="top:320px; right:60px; border-color:var(--p4);">
        <span class="bubble-title">æ­¦å™¨ (WEAPON)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-weapon')">+</button>
        <div class="resize-handle"></div>
      </div>

      <div id="b-scheme" class="parent-bubble" style="top:180px; right:160px; border-color:var(--p2);">
        <span class="bubble-title">ã‚¹ã‚­ãƒ¼ãƒ  (SCHEME)</span>
        <button class="quick-add-btn no-print" onclick="smartAdd('b-scheme')">+</button>
        <div class="resize-handle"></div>
      </div>
    </section>

    <section class="flow-container">
      <div class="flow-card" style="border-color:var(--p1)">
        <span style="font-size:10px; font-weight:1000;">â‘  ã‚¿ã‚¤ãƒˆãƒ«</span>
        <div class="flow-input" contenteditable="true" data-flow="0"></div>
      </div>
      <div class="flow-card" style="border-color:var(--p5)">
        <span style="font-size:10px; font-weight:1000;">â‘¡ å°å…¥</span>
        <div class="flow-input" contenteditable="true" data-flow="1"></div>
      </div>
      <div class="flow-card" style="border-color:var(--p1)">
        <span style="font-size:10px; font-weight:1000;">â‘¢ ç¾çŠ¶åˆ†æ</span>
        <div class="flow-input" contenteditable="true" data-flow="2"></div>
      </div>
      <div class="flow-card" style="border-color:var(--p3)">
        <span style="font-size:10px; font-weight:1000;">â‘£ è§£æ±ºç­–</span>
        <div class="flow-input" contenteditable="true" data-flow="3"></div>
      </div>
      <div class="flow-card" style="border-color:var(--p2)">
        <span style="font-size:10px; font-weight:1000;">â‘¤ æ¤œè¨¼</span>
        <div class="flow-input" contenteditable="true" data-flow="4"></div>
      </div>
      <div class="flow-card" style="border-color:#111827">
        <span style="font-size:10px; font-weight:1000;">â‘¥ ãƒ“ã‚¸ãƒ§ãƒ³</span>
        <div class="flow-input" contenteditable="true" data-flow="5"></div>
      </div>
    </section>

    <section>
      <div class="section-title">ğŸ¬ å‹•ç”»åˆ¶ä½œå·¥ç¨‹è¡¨ (å…¨6è©±æ§‹æˆ)</div>
      <table>
        <thead>
          <tr>
            <th>è©±æ•°</th><th>ãƒ†ãƒ¼ãƒãƒ»æ’®å½±å†…å®¹</th><th>æ’®å½±æ™‚æœŸ</th><th>å ´æ‰€</th><th>å‡ºæ¼”è€…</th><th>æ©Ÿæ</th><th>å‚™è€ƒ</th>
          </tr>
        </thead>
        <tbody id="video-tbody"></tbody>
      </table>
    </section>

    <section>
      <div class="section-title">ğŸ“… å®Ÿè¡Œã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
      <table>
        <thead>
          <tr>
            <th style="width: 120px;">è¦ç´ </th><th>WHAT</th><th>WHO</th><th>WHEN</th><th>WHERE</th><th>WHY</th><th>HOW</th>
          </tr>
        </thead>
        <tbody id="task-tbody">
          <tr>
            <td style="font-weight:1000; border-left:4px solid var(--p1);">â‘ ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</td>
            <td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td>
          </tr>
          <tr>
            <td style="font-weight:1000; border-left:4px solid var(--p4);">â‘¡ã‚¦ã‚¨ãƒãƒ³åˆ¶ä½œ</td>
            <td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td>
          </tr>
          <tr>
            <td style="font-weight:1000; border-left:4px solid var(--p2);">â‘¢ã‚¤ãƒ™ãƒ³ãƒˆ</td>
            <td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td>
          </tr>
        </tbody>
      </table>
    </section>
  </div>

  <!-- Page 2: Plan -->
  <div class="page tab-content" id="tab-plan" style="display:none;">
    <h1 class="page-title">ğŸ“„ ä¼ç”»æ›¸ï¼ˆå–æã®ãŠé¡˜ã„ï¼‰</h1>

    <!-- hidden file input for plan images -->
    <input id="plan-image-input" class="no-print" type="file" accept="image/*" multiple style="display:none" />

    <div class="inputbar no-print">
      <div class="left">
        <div class="title">ğŸ§© ç©´åŸ‹ã‚å…¥åŠ›</div>
        <div class="desc">ã€Œå…¥åŠ›ã‚’é–‹ãã€â†’å¿…è¦é …ç›®ã‚’å…¥åŠ› â†’ã€Œä¼ç”»æ›¸ã«åæ˜ ã€</div>
      </div>
      <div class="right">
        <div class="fontctl" title="ä¼ç”»æ›¸ã®æ–‡å­—ã‚µã‚¤ã‚º">
          <span>æ–‡å­—</span>
          <input id="plan-font-range" type="range" min="9" max="14" step="1" value="11" />
          <span id="plan-font-val">11px</span>
        </div>

        <!-- â˜…è¿½åŠ ï¼šA4ã«åã‚ã‚‹ -->
        <button class="mini-btn" onclick="fitPlanToA4()">ğŸª„ A4ã«åã‚ã‚‹</button>

        <button class="mini-btn" onclick="toggleDrawer('plan-input')">ğŸ§© å…¥åŠ›ã‚’é–‹ã/é–‰ã˜ã‚‹</button>
        <button class="mini-btn primary" onclick="regenPlan()">ğŸ”„ ä¼ç”»æ›¸ã«åæ˜ </button>
        <button class="mini-btn" onclick="openPlanImagePicker()">ğŸ–¼ï¸ ç”»åƒè¿½åŠ ï¼ˆæœ€å¤§2ï¼‰</button>
        <button class="mini-btn" onclick="copyDoc('plan-doc-area')">ğŸ“‹ ä¼ç”»æ›¸ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div class="inputdrawer no-print" id="plan-input">
      <div class="fields-grid">
        <div>
          <div class="field"><label>ä½œæˆæ—¥</label><input data-field="createdDate" placeholder="ä¾‹ï¼‰2026å¹´1æœˆ21æ—¥"></div>
          <div class="field"><label>ä¼æ¥­å</label><input data-field="companyName" placeholder="ä¾‹ï¼‰æ ªå¼ä¼šç¤¾ã€‡ã€‡"></div>
          <div class="field"><label>éƒ¨ç½²å</label><input data-field="department" placeholder="ä¾‹ï¼‰åºƒå ±éƒ¨"></div>
          <div class="field"><label>ã”æ‹…å½“è€…</label><input data-field="contactName" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ"></div>

          <div class="field"><label>å­¦æ ¡å</label><input data-field="schoolName" placeholder="ä¾‹ï¼‰ã€‡ã€‡é«˜ç­‰å­¦æ ¡"></div>
          <div class="field"><label>å­¦å¹´</label><input data-field="grade" placeholder="ä¾‹ï¼‰2å¹´"></div>
          <div class="field"><label>ç”Ÿå¾’ä»£è¡¨</label><input data-field="studentRep" placeholder="ä¾‹ï¼‰ã€‡ã€‡ ã€‡ã€‡"></div>
          <div class="field"><label>æ‹…å½“æ•™å“¡</label><input data-field="teacherRep" placeholder="ä¾‹ï¼‰ã€‡ã€‡ ã€‡ã€‡"></div>
        </div>

        <div>
          <div class="field"><label>ãƒ†ãƒ¼ãƒ</label><input data-field="theme" placeholder="ä¾‹ï¼‰åœ°åŸŸã®é˜²ç½æ„è­˜ã‚’é«˜ã‚ã‚‹æ–¹æ³•"></div>

          <div class="field"><label>ç¬¬1å¸Œæœ›</label><input data-field="dt1" placeholder="ä¾‹ï¼‰2æœˆ3æ—¥ 16:00ã€œ"></div>
          <div class="field"><label>ç¬¬2å¸Œæœ›</label><input data-field="dt2" placeholder="ä¾‹ï¼‰2æœˆ5æ—¥ 10:00ã€œ"></div>
          <div class="field"><label>ç¬¬3å¸Œæœ›</label><input data-field="dt3" placeholder="ä¾‹ï¼‰2æœˆ6æ—¥ 17:30ã€œ"></div>

          <div class="field"><label>ç”Ÿå¾’äººæ•°</label><input data-field="studentsCount" placeholder="ä¾‹ï¼‰5"></div>
          <div class="field"><label>æ•™å“¡äººæ•°</label><input data-field="teachersCount" placeholder="ä¾‹ï¼‰1"></div>
          <div class="field"><label>å ´æ‰€</label><input data-field="place" placeholder="ä¾‹ï¼‰è²´ç¤¾ä¼šè­°å®¤ / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³"></div>

          <div class="field"><label>å†…å®¹èª¬æ˜</label><textarea data-field="planDescText" placeholder="ä¾‹ï¼‰å½“æ—¥ã¯ã€äº‹æ¥­æ¦‚è¦ãƒ»èª²é¡Œãƒ»å·¥å¤«ãƒ»ä»Šå¾Œã®å±•æœ›ã«ã¤ã„ã¦ä¼ºã„ã€æˆæ¥­æˆæœã¨ã—ã¦ç™ºè¡¨è³‡æ–™ã«ã¾ã¨ã‚ã¾ã™ã€‚"></textarea></div>

          <div class="field"><label>ãƒ¡ãƒ¼ãƒ«</label><input data-field="email" placeholder="ä¾‹ï¼‰xxx@example.com"></div>
          <div class="field"><label>é›»è©±</label><input data-field="phone" placeholder="ä¾‹ï¼‰000-0000-0000"></div>
        </div>
      </div>
      <div style="font-size:11px; color:var(--muted); margin-top:8px; line-height:1.6;">
        â€»ã€Œç”»åƒè¿½åŠ ï¼ˆæœ€å¤§2ï¼‰ã€ã§ã€ä¼ç”»æ›¸ã®<strong>å†…å®¹èª¬æ˜</strong>ã®ç®‡æ‰€ã«ç”»åƒã‚’æŒ¿å…¥ã§ãã¾ã™ï¼ˆä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚<br>
        â€»ç”»åƒã¯<strong>å‰Šé™¤ï¼å·®ã—æ›¿ãˆï¼ã‚µã‚¤ã‚ºå¤‰æ›´ï¼ˆæ‹¡å¤§ç¸®å°ï¼‰</strong>ã§ãã¾ã™ã€‚<br>
        â€»ã•ã‚‰ã«<strong>ç”»åƒæ ï¼ˆæŒ¿å…¥ä½ç½®ã®å æœ‰ã‚µã‚¤ã‚ºï¼‰</strong>ã‚‚å¤‰æ›´ã§ãã¾ã™ï¼ˆA4 1æšã«åã‚ã‚„ã™ããªã‚Šã¾ã™ï¼‰ã€‚
      </div>
    </div>

    <div class="doc-area">
      <p class="hint no-print">âœ… æœ¬æ–‡ã¯<strong>ãã®ã¾ã¾ç·¨é›†ã§ãã¾ã™</strong>ã€‚å°åˆ·æ™‚ã¯ã“ã®æœ¬æ–‡ã ã‘ãŒãƒšãƒ¼ã‚¸ã¨ã—ã¦å‡ºã¾ã™ã€‚</p>
      <div id="plan-doc-area"></div>
    </div>
  </div>

  <!-- Page 3: Presentation -->
  <div class="page tab-content" id="tab-pres" style="display:none;">
    <h1 class="page-title">ğŸ¤ ãƒ—ãƒ¬ã‚¼ãƒ³å°æœ¬</h1>

    <div class="inputbar no-print">
      <div class="left">
        <div class="title">ğŸ§© ç©´åŸ‹ã‚å…¥åŠ›</div>
        <div class="desc">å¿…è¦é …ç›®â†’ã€Œå°æœ¬ã«åæ˜ ã€ï¼æœ¬æ–‡ã¯å°åˆ·ã§å˜ä½“ãƒšãƒ¼ã‚¸åŒ–</div>
      </div>
      <div class="right">
        <button class="mini-btn" onclick="toggleDrawer('pres-input')">ğŸ§© å…¥åŠ›ã‚’é–‹ã/é–‰ã˜ã‚‹</button>
        <button class="mini-btn primary" onclick="regenPres()">ğŸ”„ å°æœ¬ã«åæ˜ </button>
        <button class="mini-btn" onclick="copyDoc('pres-doc-area')">ğŸ“‹ å°æœ¬ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div class="inputdrawer no-print" id="pres-input">
      <div class="fields-grid">
        <div>
          <div class="field"><label>ãƒãƒ¼ãƒ å</label><input data-field="teamName" placeholder="ä¾‹ï¼‰æ¢ç©¶ãƒãƒ¼ãƒ A"></div>
          <div class="field"><label>ç™ºè¡¨ãƒ†ãƒ¼ãƒ</label><input data-field="presTopic" placeholder="ä¾‹ï¼‰é˜²ç½Ã—è‹¥è€…ã®è¡Œå‹•å¤‰å®¹"></div>

          <div class="field"><label>ç¾å ´ã§å®Ÿæ–½â‘ </label><input data-field="fieldAction1" placeholder="ä¾‹ï¼‰å¸‚å½¹æ‰€ã¸ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼"></div>
          <div class="field"><label>æ°—ã¥ãâ‘ </label><input data-field="insight1" placeholder="ä¾‹ï¼‰æƒ…å ±ãŒå±Šã„ã¦ã„ãªã„å±¤ãŒã„ã‚‹"></div>
          <div class="field"><label>èª¿æŸ»â‘¡</label><input data-field="research2" placeholder="ä¾‹ï¼‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª¿æŸ»"></div>
          <div class="field"><label>äº‹å®Ÿâ‘¡</label><input data-field="fact2" placeholder="ä¾‹ï¼‰è‹¥å¹´å±¤ã®å‚™è“„ç‡ãŒä½ã„"></div>
          <div class="field"><label>æœ¬å½“ã®å•é¡Œ</label><input data-field="coreProblem" placeholder="ä¾‹ï¼‰è¡Œå‹•ã«ã¤ãªãŒã‚‹å°ç·šä¸è¶³"></div>

          <div class="field"><label>ä»®èª¬ï¼ˆåŸå› ï¼‰</label><input data-field="hypCause" placeholder="ä¾‹ï¼‰ä½“é¨“ãŒä¸è¶³"></div>
          <div class="field"><label>ä»®èª¬ï¼ˆç†ç”±ï¼‰</label><input data-field="hypReason" placeholder="ä¾‹ï¼‰å®Ÿæ„ŸãŒãªã„ã¨è¡Œå‹•ã—ãªã„"></div>
          <div class="field"><label>ä»®èª¬ï¼ˆæœ‰åŠ¹ç­–ï¼‰</label><input data-field="hypSolution" placeholder="ä¾‹ï¼‰ARä½“é¨“ãŒæœ‰åŠ¹"></div>
        </div>

        <div>
          <div class="field"><label>ã‚¢ã‚¤ãƒ‡ã‚¢å</label><input data-field="ideaName" placeholder="ä¾‹ï¼‰é˜²ç½ARä½“é¨“"></div>
          <div class="field"><label>ã‚³ãƒ³ã‚»ãƒ—ãƒˆ</label><input data-field="concept" placeholder="ä¾‹ï¼‰ã‚¹ãƒãƒ›ã§æµ¸æ°´ã‚’è¦‹ãˆã‚‹åŒ–"></div>
          <div class="field"><label>ç‰¹å¾´â‘ </label><input data-field="feature1" placeholder="ä¾‹ï¼‰å­¦æ ¡ã§ç°¡å˜ã«ä½“é¨“"></div>
          <div class="field"><label>ç‰¹å¾´â‘¡</label><input data-field="feature2" placeholder="ä¾‹ï¼‰åœ°åŸŸãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œ"></div>

          <div class="field"><label>æ¤œè¨¼æ–¹æ³•</label><input data-field="verifyMethod" placeholder="ä¾‹ï¼‰ä½“é¨“å‰å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ"></div>
          <div class="field"><label>æ¤œè¨¼æ‰‹é †â‘ </label><input data-field="verifyStep1" placeholder="ä¾‹ï¼‰ä½“é¨“ä¼šã‚’å®Ÿæ–½"></div>
          <div class="field"><label>ç¢ºèªé …ç›®</label><input data-field="verifyCheck" placeholder="ä¾‹ï¼‰å‚™è“„æ„æ¬²ã®å¤‰åŒ–"></div>

          <div class="field"><label>å®Ÿæ–½æ—¥</label><input data-field="doDate" placeholder="ä¾‹ï¼‰2æœˆ10æ—¥"></div>
          <div class="field"><label>å®Ÿæ–½å ´æ‰€</label><input data-field="doPlace" placeholder="ä¾‹ï¼‰å­¦æ ¡ã®æ•™å®¤"></div>
          <div class="field"><label>å¯¾è±¡</label><input data-field="target" placeholder="ä¾‹ï¼‰é«˜æ ¡2å¹´ç”Ÿ 30å"></div>
          <div class="field"><label>å®Ÿæ–½å†…å®¹</label><input data-field="doWhat" placeholder="ä¾‹ï¼‰ARä½“é¨“ï¼‹èª¬æ˜"></div>

          <div class="field"><label>ãƒ‡ãƒ¼ã‚¿â‘ </label><input data-field="data1" placeholder="ä¾‹ï¼‰æ„æ¬²ãŒ30%å¢—"></div>
          <div class="field"><label>åˆ†ã‹ã£ãŸã“ã¨</label><input data-field="learned" placeholder="ä¾‹ï¼‰ä½“é¨“ãŒå¼·ã„å‹•æ©Ÿã«"></div>
          <div class="field"><label>çµè«–</label><input data-field="conclusion" placeholder="ä¾‹ï¼‰ARä½“é¨“ã¯æœ‰åŠ¹"></div>

          <div class="field"><label>è€ƒå¯Ÿ</label><textarea data-field="discussion" placeholder="ä¾‹ï¼‰æ™‚é–“ç¢ºä¿ãŒèª²é¡Œâ€¦"></textarea></div>
          <div class="field"><label>ä»Šå¾Œå¿…è¦</label><input data-field="nextNeed" placeholder="ä¾‹ï¼‰åœ°åŸŸã¨é€£æº"></div>
          <div class="field"><label>æœªæ¥</label><input data-field="future" placeholder="ä¾‹ï¼‰é˜²ç½è¡Œå‹•ãŒå½“ãŸã‚Šå‰ã«"></div>
        </div>
      </div>
    </div>

    <div class="doc-area">
      <p class="hint no-print">âœ… æœ¬æ–‡ã¯<strong>å®Œæˆæ–‡</strong>ã¨ã—ã¦ç·¨é›†ã§ãã¾ã™ã€‚å°åˆ·æ™‚ã¯ã“ã®æœ¬æ–‡ã ã‘ãŒãƒšãƒ¼ã‚¸ã¨ã—ã¦å‡ºã¾ã™ã€‚</p>
      <div id="pres-doc-area"></div>
    </div>
  </div>

  <!-- Page 4: Video Script -->
  <div class="page tab-content" id="tab-video" style="display:none;">
    <h1 class="page-title">ğŸ¬ å‹•ç”»å°æœ¬ï¼ˆå…¨6è©± Ã— 8ã‚«ãƒƒãƒˆï¼‰</h1>

    <div class="section-title no-print">ğŸ“Œ ä½¿ã„æ–¹</div>
    <div class="no-print" style="font-size:12px; color:var(--muted); line-height:1.6;">
      ãƒ»å„è¡Œã¯ã€Œ1ã‚«ãƒƒãƒˆï¼ãƒ†ãƒ­ãƒƒãƒ—1æ–‡ã€æƒ³å®šï¼ˆçŸ­ãå¼·ãï¼‰ã€‚<br>
      ãƒ»æœ€åˆã«<strong>æ±ºã‚å°è©ï¼ˆå®£è¨€ï¼‰</strong> â†’ 1æ–‡ãšã¤ã§å†…å®¹èª¬æ˜ â†’ æœ€å¾Œã«<strong>æ¬¡å›äºˆå‘Š</strong>ã®æµã‚Œã€‚<br>
      ãƒ»æ±ºã‚å°è©ã¯<strong>ã©ã‚Œã‹1è©±ã®1ã‚«ãƒƒãƒˆç›®ã«å…¥åŠ›ã™ã‚Œã°ã€å…¨6è©±ã®å†’é ­ã«åŒæœŸ</strong>ã•ã‚Œã¾ã™ã€‚<br>
      ãƒ»ã€ŒğŸ”„ è‡ªå‹•ä¸‹æ›¸ãã€ã§ã€ä»Šã®å…¥åŠ›ï¼ˆä¼ç”»æ›¸/ãƒ—ãƒ¬ã‚¼ãƒ³/ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ã‹ã‚‰å°æœ¬ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ï¼ˆç·¨é›†OKï¼‰ã€‚
    </div>

    <div class="doc-actions no-print" style="margin-top:10px;">
      <button class="mini-btn primary" onclick="autoDraftVideo()">ğŸ”„ è‡ªå‹•ä¸‹æ›¸ã</button>
      <button class="mini-btn" onclick="manualSave()">ğŸ’¾ ä¿å­˜</button>
    </div>

    <div class="section-title" style="margin-top:12px;">ğŸ—‚ï¸ å°æœ¬ & é€²æ—ï¼ˆè¡¨å½¢å¼ï¼‰</div>
    <table class="video-script-table">
      <thead>
        <tr>
          <th style="width:44px;">è©±</th>
          <th style="width:58px;">ã‚«ãƒƒãƒˆ</th>
          <th>ãƒ†ãƒ­ãƒƒãƒ—ï¼ˆ1æ–‡ï¼‰</th>
          <th>æ˜ åƒã‚¤ãƒ¡ãƒ¼ã‚¸</th>
          <th style="width:90px;">æ’®å½±</th>
          <th style="width:90px;">ç·¨é›†</th>
        </tr>
      </thead>
      <tbody id="video-script-tbody"></tbody>
    </table>
  </div>
</div>

<script>
  /* -------------------------
     Storage / Data
  ------------------------- */
  const STORAGE_KEY = 'bubbleStrategyV15'; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿äº’æ›ã®ãŸã‚ã‚­ãƒ¼ã¯ç¶­æŒ
  function safeLoad(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { folders: [] };
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return { folders: [] };
      if(!Array.isArray(parsed.folders)) parsed.folders = [];
      return parsed;
    }catch(e){
      return { folders: [] };
    }
  }
  let data = safeLoad();
  let currentId = null;
  let activeElem = null;
  let resizeElem = null;
  let offset = { x: 0, y: 0 };

  const masterConfig = {
    'b-theme': ['ç¤¾ä¼šå•é¡Œ', 'èª²é¡Œ'],
    'b-action': ['ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼', 'ã‚¤ãƒ™ãƒ³ãƒˆ'],
    'b-idea': ['1', '2', '3'],
    'b-story': ['å¥½ããªãƒ¢ãƒ', 'çµŒé¨“', 'å¤¢'],
    'b-scheme': ['å”åŠ›è€…', 'ãƒ‘ãƒˆãƒ­ãƒ³', 'é¡§å®¢'],
    'b-weapon': ['ã‚¹ã‚­ãƒ«', 'ã‚µãƒ¼ãƒ“ã‚¹', 'ã‚¢ãƒ—ãƒª', 'å•†å“']
  };

  const PLAN_TEMPLATE = [
    {"align":"right","text":"ä½œæˆæ—¥ï¼š20XXå¹´XXæœˆXXæ—¥"},
    {"align":"center","text":"å–æã®ãŠé¡˜ã„"},
    {"align":"left","text":"ï¼ˆä¼æ¥­åï¼‰ï¼ˆéƒ¨ç½²åï¼‰"},
    {"align":"left","text":"ã”æ‹…å½“è€…æ§˜"},
    {"align":"right","text":"æ‰€å±ï¼šï¼ˆå­¦æ ¡åï¼‰ï¼ˆå­¦å¹´ï¼‰"},
    {"align":"right","text":"ç”Ÿå¾’ä»£è¡¨ï¼šã€€ã€€ã€€ã€€ã€€"},
    {"align":"right","text":"æ‹…å½“æ•™å“¡ï¼šã€€ã€€ã€€ã€€ã€€"},
    {"align":"left","text":""},

    {"align":"center","text":"è¬è¾"},
    {"align":"left","text":""},

    {"align":"left","text":"çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚ç§ãŸã¡ã¯ï¼ˆå­¦æ ¡åï¼‰ã®æ¢ç©¶å­¦ç¿’ã®ä¸€ç’°ã¨ã—ã¦ã€ï¼ˆãƒ†ãƒ¼ãƒï¼šã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼‰ã«ã¤ã„ã¦å­¦ã‚“ã§ãŠã‚Šã¾ã™ã€‚\nã¤ãã¾ã—ã¦ã¯ã€è²´ç¤¾ãƒ»è²´å›£ä½“ã®ã”æ¥­å‹™ãƒ»ãŠå–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ çŸ­æ™‚é–“ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å–æï¼ˆ30åˆ†ã‹ã‚‰ä¸€æ™‚é–“ç¨‹åº¦ï¼‰ ã«ã”å”åŠ›ã„ãŸã ã‘ãªã„ã§ã—ã‚‡ã†ã‹ã€‚\nã”å¤šå¿™ã®ã¨ã“ã‚æç¸®ã§ã™ãŒã€ã”æ¤œè¨ã®ã»ã©ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"},
    {"align":"left","text":""},

    {"align":"left","text":"å–æã®ç›®çš„"},
    {"align":"left","text":"æ¢ç©¶ãƒ†ãƒ¼ãƒã«é–¢ã™ã‚‹ã€Œç¾å ´ã®è¦–ç‚¹ãƒ»å®Ÿå‹™ã®çŸ¥è¦‹ã€ã‚’ä¼ºã„ã€å­¦ç¿’ã®è³ªã‚’é«˜ã‚ã‚‹ãŸã‚"},
    {"align":"left","text":"å–æå†…å®¹ã¯ã€æˆæ¥­å†…ã®æˆæœç‰©ï¼ˆç™ºè¡¨ãƒ»ãƒ¬ãƒãƒ¼ãƒˆç­‰ï¼‰ã«æ´»ç”¨ã—ã¾ã™"},
    {"align":"left","text":""},

    {"align":"left","text":"å–ææ¦‚è¦ï¼ˆå¸Œæœ›ï¼‰"},
    {"align":"left","text":"å½¢å¼ï¼šå¯¾é¢ï¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆZoomç­‰ï¼‰"},
    {"align":"left","text":"æ‰€è¦æ™‚é–“ï¼š30åˆ†ï¼ˆæœ€å¤§45åˆ†ï¼‰"},
    {"align":"left","text":"å€™è£œæ—¥æ™‚ï¼š\nç¬¬1å¸Œæœ›ï¼ˆã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œï¼‰ï¼ç¬¬2å¸Œæœ›ï¼ˆã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œï¼‰ï¼ç¬¬3å¸Œæœ›ï¼ˆã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œï¼‰"},
    {"align":"left","text":"å‚åŠ è€…ï¼šç”Ÿå¾’ï¼ˆã€€åï¼‰ï¼‹æ•™å“¡ï¼ˆã€€åï¼‰"},
    {"align":"left","text":"å ´æ‰€ï¼šï¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³"},
    {"align":"left","text":""},

    {"align":"left","text":"å†…å®¹èª¬æ˜"},
    {"align":"left","text":"__CONTENT_DESC_BLOCK__"},
    {"align":"left","text":""},

    {"align":"left","text":"ãŠä¼ºã„ã—ãŸã„å†…å®¹ï¼ˆä¾‹ï¼‰"},
    {"align":"left","text":"è²´ç¤¾ã®äº‹æ¥­æ¦‚è¦ã¨ç¾åœ¨ã®çŠ¶æ³ï¼ˆé¡§å®¢ãƒ»å¸‚å ´ãƒ»èª²é¡Œæ„Ÿï¼‰"},
    {"align":"left","text":"èª²é¡Œã«å¯¾ã™ã‚‹å–ã‚Šçµ„ã¿ï¼ˆæ–½ç­–ãƒ»å·¥å¤«ãƒ»æŠ€è¡“æ´»ç”¨ç­‰ï¼‰"},
    {"align":"left","text":"æˆæœã¨é›£ã—ã•ï¼ˆåŠ¹æœãƒ»éšœå£ãƒ»å­¦ã³ï¼‰"},
    {"align":"left","text":"ä»Šå¾Œã®å±•æœ›ï¼ˆæ¬¡ã®ä¸€æ‰‹ã€å¿…è¦ãªé€£æºï¼‰"},
    {"align":"left","text":"ä¸­é«˜ç”Ÿã‚„åœ°åŸŸã«æœŸå¾…ã™ã‚‹ã“ã¨ï¼ˆé–¢ã‚ã‚Šæ–¹ã®ãƒ’ãƒ³ãƒˆï¼‰"},
    {"align":"left","text":""},

    {"align":"left","text":"è³‡æ–™ã‚„å†™çœŸã«ã¤ã„ã¦"},
    {"align":"left","text":"å½“æ—¥ã«é ‚ã„ãŸè³‡æ–™ã‚„æƒ…å ±ã€æ’®å½±ã—ãŸå†™çœŸã‚„å‹•ç”»ã«ã¤ãã¾ã—ã¦ã¯ã€å­¦æ ¡ã‚„éƒ¨ã®æ´»å‹•ã‚’ç™ºä¿¡ã—ã¦ã„ã‚‹SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŠã‚ˆã³ã€å‚åŠ ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã§ã®ç™ºè¡¨è³‡æ–™ã¨ã—ã¦ä½¿ç”¨ã•ã›ã¦é ‚ãå ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ²è¼‰å¯å¦ãƒ»ç¯„å›²ã«ã¤ã„ã¦ã¯å¿…ãšç¢ºèªã„ãŸã—ã¾ã™ã€‚"},
    {"align":"left","text":""},

    {"align":"right","text":"ã€é€£çµ¡å…ˆã€‘"},
    {"align":"right","text":"ãƒ¡ãƒ¼ãƒ«ï¼šï¼ˆã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼‰\né›»è©±ï¼šï¼ˆã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼‰"}
  ];

  const PRES_RAW = [
    "è¡¨é¡Œ",
    "ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚ãƒãƒ¼ãƒ ã€Œã€ã§ã™ã€‚æœ¬æ—¥ã¯ã€Œã€ã«ã¤ã„ã¦ç™ºè¡¨ã—ã¾ã™ã€‚",
    "------------------------",
    "å°å…¥",
    "çªç„¶ã§ã™ãŒã€çš†ã•ã‚“ã¯æ—¥å¸¸ã®ä¸­ã§ã€Œã“ã‚Œã€ãŠã‹ã—ã„ãªï¼Ÿã€ã¨æ€ã£ãŸçµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿç§ãŸã¡ãŒä»Šå›æ³¨ç›®ã—ãŸã®ã¯ã€ã€Œã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§ã™ã€‚",
    "------------------------",
    "ç¾çŠ¶åˆ†æ",
    "ç§ãŸã¡ã¯ç¾å ´ã¸è¶³ã‚’é‹ã³ã¾ã—ãŸã€‚ã¾ãšã€Œã€ã‚’è¡Œã£ã¦ã¿ã‚‹ã¨ã€æ„å¤–ãªã“ã¨ã«ã€Œã€ã ã¨æ°—ã¥ã„ãŸã®ã§ã™ã€‚ãã“ã§æ°—ã«ãªã£ã¦ã€Œã€ã‚‚èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚ã™ã‚‹ã¨ã€ã€Œã€ã¨ã„ã†è¡æ’ƒçš„ãªäº‹å®ŸãŒè¦‹ãˆã¦ãã¾ã—ãŸã€‚ã¤ã¾ã‚Šã€æœ¬å½“ã®å•é¡Œã¯ã€Œã€ã ã£ãŸã®ã§ã™ã€‚",
    "------------------------",
    "ä»®èª¬",
    "ç¾çŠ¶åˆ†æã‹ã‚‰ã€ç§ãŸã¡ã¯ã€Œã€ãŒåŸå› ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚ãã“ã§ã€ã€Œã€ã¨ã„ã†ç†ç”±ã‹ã‚‰ã€ã€Œã€ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã¨ã„ã†ä»®èª¬ã‚’ç«‹ã¦ã¾ã—ãŸã€‚",
    "------------------------",
    "è§£æ±ºç­–",
    "ã“ã®ä»®èª¬ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ç§ãŸã¡ãŒè€ƒæ¡ˆã—ãŸã®ãŒã€ã€Œã€ã§ã™ã€‚ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¯ã‚ºãƒãƒªã€ã€Œã€ã€‚å…·ä½“çš„ã«ã¯ã€Œã€ã‚„ã€Œã€ã¨ã„ã£ãŸç‰¹å¾´ã§ã€æ–°ã—ã„ä¾¡å€¤ã‚’æä¾›ã—ã¾ã™ã€‚",
    "------------------------",
    "æ¤œè¨¼è¨ˆç”»",
    "ç¶šã„ã¦ã€ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒæœ¬å½“ã«æœ‰åŠ¹ã‹ã‚’ç¢ºã‹ã‚ã‚‹ãŸã‚ã«ã€ã€Œã€ã¨ã„ã†æ¤œè¨¼ã‚’è¨ˆç”»ã—ã¾ã—ãŸã€‚ã¾ãšã€Œã€ã‚’è¡Œã„ã€å®Ÿéš›ã«ã€Œã€ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚",
    "------------------------",
    "å®Ÿæ–½å ±å‘Š",
    "å®Ÿéš›ã®æ¤œè¨¼ã¯ã€ã€Œã€ã«ã€Œã€ã§è¡Œã„ã¾ã—ãŸã€‚å¯¾è±¡ã¯ã€Œã€ã§ã™ã€‚å†™çœŸã«ã‚ã‚‹ã‚ˆã†ã«ã€ç§ãŸã¡ã¯ã€Œã€ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚",
    "------------------------",
    "çµæœ",
    "å®Ÿæ–½ã—ãŸçµæœã€ã¾ãšã€Œã€ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ã¾ãŸã€ã€Œã€ã¨ã„ã†ã“ã¨ã‚‚åˆ†ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚‰ã®çµæœã‹ã‚‰ã€ç§ãŸã¡ã¯ã€Œã€ã¨ã„ã†çµè«–ã«è‡³ã‚Šã¾ã—ãŸã€‚",
    "------------------------",
    "è€ƒå¯Ÿ",
    "ã“ã®çµæœã«å¯¾ã™ã‚‹è€ƒå¯Ÿã§ã™ã€‚ã€Œã€ã¨ã„ã†ã“ã¨ãŒè¨€ãˆã¾ã™ã€‚ã—ã‹ã—ã€åŒæ™‚ã«ã€Œã€ã¨ã„ã†èª²é¡Œã‚‚è¦‹ãˆã¦ãã¾ã—ãŸã€‚ä»Šå¾Œã¯ã€Œã€ãŒå¿…è¦ã ã¨è€ƒãˆã¾ã™ã€‚",
    "------------------------",
    "å±•æœ›",
    "æœ€å¾Œã«ã€ç§ãŸã¡ã®ãƒ“ã‚¸ãƒ§ãƒ³ã§ã™ã€‚ã‚‚ã—ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒåºƒã¾ã‚Œã°ã€ã€Œã€æœªæ¥ã«ãªã‚‹ã¨ä¿¡ã˜ã¦ã„ã¾ã™ã€‚ã€‚ã”æ¸…è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚",
    "------------------------"
  ];

  /* -------------------------
     Init tables (Canvas page)
  ------------------------- */
  const vt = document.getElementById('video-tbody');
  for(let i=1; i<=6; i++){
    vt.innerHTML += `<tr>
      <td style="text-align:center; font-weight:1000;">ç¬¬ ${i} è©±</td>
      <td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td>
    </tr>`;
  }

  /* -------------------------
     Video Script Table
  ------------------------- */
  const LINES_PER_EP = 8;

  function buildVideoScriptTable(){
    const tbody = document.getElementById('video-script-tbody');
    tbody.innerHTML = "";
    for(let ep=1; ep<=6; ep++){
      for(let cut=1; cut<=LINES_PER_EP; cut++){
        const rid = `ep${ep}-c${cut}`;
        const isEpStart = (cut===1);
        tbody.innerHTML += `
          <tr data-rowid="${rid}" data-ep="${ep}" data-ep-start="${isEpStart}">
            <td style="text-align:center; font-weight:1000;">${ep}</td>
            <td style="text-align:center; color:#64748b; font-weight:1000;">${cut}</td>
            <td contenteditable data-vs="text"></td>
            <td contenteditable data-vs="visual"></td>
            <td>
              <select class="status-select" data-vs="shoot">
                <option>æœªç€æ‰‹</option><option>æº–å‚™ä¸­</option><option>æ’®å½±ä¸­</option><option>æ’®å½±æ¸ˆ</option>
              </select>
            </td>
            <td>
              <select class="status-select" data-vs="edit">
                <option>æœªç€æ‰‹</option><option>ç·¨é›†ä¸­</option><option>ä»®å®Œæˆ</option><option>å®Œæˆ</option>
              </select>
            </td>
          </tr>
        `;
      }
    }
  }
  buildVideoScriptTable();

  /* -------------------------
     Utils
  ------------------------- */
  function getClientCoords(e){
    if(e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }
  function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function toast(){
    const t = document.getElementById('toast');
    t.style.opacity = "1";
    setTimeout(()=> t.style.opacity="0", 1500);
  }
  function manualSave(){ saveEditorData(); toast(); }

  function showEditor(){
    document.getElementById('dashboard').style.display='none';
    document.getElementById('editor').style.display='block';
  }
  function showDashboard(){
    document.getElementById('dashboard').style.display='block';
    document.getElementById('editor').style.display='none';
    renderDashboard();
  }
  function goBackToDashboard(){ saveEditorData(); showDashboard(); }

  function switchTab(tabId, btn){
    document.querySelectorAll('.tab-content').forEach(el=> el.style.display='none');
    document.getElementById(tabId).style.display='block';
    document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
    if(btn) btn.classList.add('active');
    if(tabId === 'tab-plan') renderPlanDoc();
    if(tabId === 'tab-pres') renderPresDoc();
  }

  function copyDoc(areaId){
    const el = document.getElementById(areaId);
    const range = document.createRange();
    range.selectNodeContents(el);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    try{
      document.execCommand('copy');
      toast();
    }catch(e){ alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    sel.removeAllRanges();
  }

  function toggleDrawer(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle('open');
  }

  function printPlanOnly(){
    switchTab('tab-plan', document.querySelector('.tab[data-tab="tab-plan"]'));
    document.body.classList.add('print-single');

    const cleanup = ()=>{
      document.body.classList.remove('print-single');
      window.removeEventListener('afterprint', cleanup);
    };
    window.addEventListener('afterprint', cleanup);

    window.print();
  }

  /* -------------------------
     Dashboard
  ------------------------- */
  function createNewFolder(){
    const folder = { id: Date.now().toString(), name:"æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€", color:"#4facfe", projects:[], isOpen:true };
    data.folders.push(folder);
    saveToStorage(); renderDashboard();
  }

  function renderDashboard(){
    const list = document.getElementById('folder-list');
    list.innerHTML = '';
    data.folders.forEach(folder=>{
      const container = document.createElement('div');
      container.className = 'folder-container';
      container.style.borderLeftColor = folder.color;
      container.innerHTML = `
        <div class="folder-header" onclick="toggleFolder('${folder.id}')">
          <span class="folder-icon">${folder.isOpen ? 'ğŸ“‚' : 'ğŸ“'}</span>
          <div class="folder-name" contenteditable="true" onclick="event.stopPropagation()"
               onblur="updateFolderName('${folder.id}', this.innerText)">${escapeHtml(folder.name)}</div>
          <div class="folder-controls" onclick="event.stopPropagation()">
            <input type="color" class="color-picker" value="${folder.color}" onchange="updateFolderColor('${folder.id}', this.value)">
            <button class="delete-item" onclick="deleteFolder('${folder.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="project-grid" style="display:${folder.isOpen ? 'grid' : 'none'}">
          ${folder.projects.map(p=>`
            <div class="project-card" onclick="openProject('${p.id}')">
              <button class="delete-item" style="position:absolute; top:6px; right:8px;" onclick="deleteProject('${p.id}', event)">Ã—</button>
              <div style="font-weight:1000; font-size:14px; margin-top:10px;">${escapeHtml(p.title || "ï¼ˆç„¡é¡Œï¼‰")}</div>
            </div>
          `).join('')}
          <div class="add-project-in-folder" onclick="createNewProject('${folder.id}')">+ æ–°è¦ä½œæˆ</div>
        </div>
      `;
      list.appendChild(container);
    });
  }

  function toggleFolder(id){
    const folder = data.folders.find(x=>x.id===id);
    if(folder){
      folder.isOpen = !folder.isOpen;
      saveToStorage();
      renderDashboard();
    }
  }
  function updateFolderName(id, name){
    const folder = data.folders.find(x=>x.id===id);
    if(folder){
      folder.name = (name || "").trim() || "æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€";
      saveToStorage();
    }
  }
  function updateFolderColor(id, color){
    const folder = data.folders.find(x=>x.id===id);
    if(folder){
      folder.color = color;
      saveToStorage();
      renderDashboard();
    }
  }
  function deleteFolder(id){
    if(!confirm("ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    data.folders = data.folders.filter(f=>f.id!==id);
    saveToStorage(); renderDashboard();
  }

  function defaultFields(){
    return {
      createdDate:"", companyName:"", department:"", contactName:"",
      schoolName:"", grade:"", studentRep:"", teacherRep:"",
      theme:"", dt1:"", dt2:"", dt3:"", studentsCount:"", teachersCount:"", place:"",
      planDescText:"",
      email:"", phone:"",
      teamName:"", presTopic:"",
      fieldAction1:"", insight1:"", research2:"", fact2:"", coreProblem:"",
      hypCause:"", hypReason:"", hypSolution:"",
      ideaName:"", concept:"", feature1:"", feature2:"",
      verifyMethod:"", verifyStep1:"", verifyCheck:"",
      doDate:"", doPlace:"", target:"", doWhat:"",
      data1:"", learned:"", conclusion:"",
      discussion:"", nextNeed:"", future:""
    };
  }

  // âœ… plan settingsï¼ˆä¿å­˜å¯¾è±¡ã‚’è¿½åŠ ï¼šlineHeight / boxHï¼‰
  function defaultPlanSettings(){
    return {
      fontSize: 11,
      lineHeight: 1.45,
      images: [] // [{src:"dataURL", scale:100, boxH:120}]
    };
  }

  function ensureProjectDefaults(p){
    if(!p.fields) p.fields = defaultFields();
    if(!p.planSettings) p.planSettings = defaultPlanSettings();

    // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼šimages ãŒ dataURLé…åˆ—ãªã‚‰ meta é…åˆ—ã¸å¤‰æ›
    if(Array.isArray(p.planSettings.images) && p.planSettings.images.length){
      const first = p.planSettings.images[0];
      if(typeof first === "string"){
        p.planSettings.images = p.planSettings.images
          .filter(Boolean)
          .slice(0,2)
          .map(src => ({ src, scale: 100, boxH: 120 }));
      }
    }
    if(!Array.isArray(p.planSettings.images)) p.planSettings.images = [];
    p.planSettings.images = p.planSettings.images.slice(0,2).map(im=>{
      if(typeof im === "string") return { src: im, scale: 100, boxH: 120 };
      const src = im?.src || "";
      const sc = parseInt(im?.scale,10);
      const bh = parseInt(im?.boxH,10);
      return {
        src,
        scale: Number.isFinite(sc) ? sc : 100,
        boxH: Number.isFinite(bh) ? bh : 120
      };
    });

    if(!Number.isFinite(p.planSettings.fontSize)) p.planSettings.fontSize = 11;
    if(!Number.isFinite(p.planSettings.lineHeight)) p.planSettings.lineHeight = 1.45;

    // âœ… å‹•ç”»ã®æ±ºã‚å°è©ï¼ˆä»»æ„ï¼‰
    if(typeof p.videoCatchphrase !== "string") p.videoCatchphrase = "";
  }

  function createNewProject(folderId){
    const id = Date.now().toString();
    const newProj = {
      id, title:"æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", bubbles:{},
      fields: defaultFields(),
      planHtml: "", presHtml: "",
      videoScriptRows: [],
      planSettings: defaultPlanSettings(),
      videoCatchphrase: ""
    };
    const f = data.folders.find(x=>x.id===folderId);
    if(!f) return;
    f.isOpen = true;
    f.projects.push(newProj);

    currentId = id;
    showEditor();
    resetEditorFields();

    Object.keys(masterConfig).forEach(bid=>{
      masterConfig[bid].forEach(label=>{
        document.getElementById(bid).appendChild(createChildDOM(label, "", 55, 50, 50));
      });
      organizePolygon(bid);
    });

    setFieldsToUI(newProj.fields);
    setPlanFontSize(newProj.planSettings.fontSize, false);
    setPlanLineHeight(newProj.planSettings.lineHeight, false);
    regenPlan(true);
    regenPres(true);

    saveEditorData();
  }

  function openProject(id){
    currentId = id;
    let p = null;
    data.folders.forEach(f=>{
      const found = f.projects.find(x=>x.id===id);
      if(found) p = found;
    });
    if(!p) return;
    ensureProjectDefaults(p);

    showEditor();

    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('.tab[data-tab="tab-canvas"]').classList.add('active');
    document.querySelectorAll('.tab-content').forEach(el=> el.style.display='none');
    document.getElementById('tab-canvas').style.display='block';

    document.getElementById('editable-title').innerText = p.title;

    // ãƒãƒ–ãƒ«å¾©å…ƒ
    document.querySelectorAll('.child-container').forEach(c=>c.remove());
    Object.keys(p.bubbles || {}).forEach(bid=>{
      const pb = document.getElementById(bid);
      const d = p.bubbles[bid];
      if(!pb || !d) return;
      pb.style.left = d.x; pb.style.top = d.y; pb.style.width = d.w; pb.style.height = d.h;
      (d.children || []).forEach(c=> pb.appendChild(createChildDOM(c.label, c.text, c.size, c.x, c.y)));
    });

    if(p.flow) document.querySelectorAll('.flow-input').forEach((el,i)=> el.innerText = p.flow[i] || "");
    if(p.video) document.querySelectorAll('#video-tbody td[contenteditable]').forEach((el,i)=> el.innerText = p.video[i] || "");
    if(p.task) document.querySelectorAll('#task-tbody td[contenteditable]').forEach((el,i)=> el.innerText = p.task[i] || "");

    setFieldsToUI(p.fields);

    setPlanFontSize(p.planSettings.fontSize, false);
    setPlanLineHeight(p.planSettings.lineHeight, false);

    renderPlanDoc(p.planHtml || "");
    renderPresDoc(p.presHtml || "");

    // video script
    buildVideoScriptTable();
    if(p.videoScriptRows && p.videoScriptRows.length){
      const tbody = document.getElementById('video-script-tbody');
      p.videoScriptRows.forEach(saved=>{
        const tr = tbody.querySelector(`tr[data-rowid="${saved.rowid}"]`);
        if(!tr) return;
        const tcell = tr.querySelector('[data-vs="text"]');
        const vcell = tr.querySelector('[data-vs="visual"]');
        const shoot = tr.querySelector('select[data-vs="shoot"]');
        const edit = tr.querySelector('select[data-vs="edit"]');
        if(tcell) tcell.innerText = saved.text || "";
        if(vcell) vcell.innerText = saved.visual || "";
        if(shoot) shoot.value = saved.shoot || "æœªç€æ‰‹";
        if(edit) edit.value = saved.edit || "æœªç€æ‰‹";
      });
    }

    // âœ… æ±ºã‚å°è©ã‚’å…¨è©±ã®å†’é ­ã¸åæ˜ ï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
    applyCatchphraseToAll(p.videoCatchphrase || getCellText('ep1-c1'));
  }

  function deleteProject(id, evt){
    try{
      if(evt) evt.stopPropagation();
      else if(window.event) window.event.stopPropagation();
    }catch(e){}
    if(!confirm("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    data.folders.forEach(f=>{ f.projects = f.projects.filter(p=>p.id!==id); });
    saveToStorage(); renderDashboard();
  }

  /* -------------------------
     Save / Load editor
  ------------------------- */
  function getCurrentProject(){
    if(!currentId) return null;
    let p=null;
    data.folders.forEach(f=>{
      const found = f.projects.find(x=>x.id===currentId);
      if(found) p=found;
    });
    if(p) ensureProjectDefaults(p);
    return p;
  }

  function saveEditorData(){
    const p = getCurrentProject();
    if(!p) return;

    p.title = document.getElementById('editable-title').innerText;

    // bubbles
    p.bubbles = {};
    document.querySelectorAll('.parent-bubble').forEach(pb=>{
      p.bubbles[pb.id] = {
        x: pb.style.left, y: pb.style.top, w: pb.style.width, h: pb.style.height,
        children: Array.from(pb.querySelectorAll('.child-container')).map(c=>({
          label: c.querySelector('.child-label').innerText,
          text: c.querySelector('.child-text').value,
          x: parseInt(c.style.left), y: parseInt(c.style.top),
          size: (()=>{
            const b = c.querySelector('.child-bubble');
            const w = parseInt((b?.style?.width || "").replace("px",""));
            const ds = parseInt(b?.dataset?.size || "");
            return (Number.isFinite(w) && w >= 40) ? w : (Number.isFinite(ds) && ds >= 40 ? ds : 55);
          })()
        }))
      };
    });

    p.flow = Array.from(document.querySelectorAll('.flow-input')).map(i=> i.innerText);
    p.video = Array.from(document.querySelectorAll('#video-tbody td[contenteditable]')).map(td=> td.innerText);
    p.task = Array.from(document.querySelectorAll('#task-tbody td[contenteditable]')).map(td=> td.innerText);

    p.fields = collectFieldsFromUI();

    const r = document.getElementById('plan-font-range');
    if(r){
      const fs = parseInt(r.value, 10);
      p.planSettings.fontSize = Number.isFinite(fs) ? fs : 11;
    }

    // lineHeight ã¯ setPlanLineHeight() ãŒ p.planSettings ã«åæ˜ æ¸ˆã¿ã®æƒ³å®š

    p.planHtml = document.getElementById('plan-doc-area').innerHTML;
    p.presHtml = document.getElementById('pres-doc-area').innerHTML;

    p.videoScriptRows = Array.from(document.querySelectorAll('#video-script-tbody tr')).map(tr=>{
      return {
        rowid: tr.dataset.rowid,
        text: (tr.querySelector('[data-vs="text"]')?.innerText || ""),
        visual: (tr.querySelector('[data-vs="visual"]')?.innerText || ""),
        shoot: (tr.querySelector('select[data-vs="shoot"]')?.value || "æœªç€æ‰‹"),
        edit: (tr.querySelector('select[data-vs="edit"]')?.value || "æœªç€æ‰‹")
      };
    });

    // âœ… æ±ºã‚å°è©ã‚’ä¿å­˜ï¼ˆep1-c1ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    p.videoCatchphrase = (getCellText('ep1-c1') || "").trim();

    saveToStorage();
  }

  function resetEditorFields(){
    document.querySelectorAll('.flow-input').forEach(el=> el.innerText="");
    document.querySelectorAll('#video-tbody td[contenteditable]').forEach(el=> el.innerText="");
    document.querySelectorAll('#task-tbody td[contenteditable]').forEach(el=> el.innerText="");
    document.querySelectorAll('.child-container').forEach(c=> c.remove());
    document.querySelectorAll('[data-field]').forEach(el=> el.value="");
    document.getElementById('plan-doc-area').innerHTML = "";
    document.getElementById('pres-doc-area').innerHTML = "";
    buildVideoScriptTable();

    document.getElementById('plan-input')?.classList.remove('open');
    document.getElementById('pres-input')?.classList.remove('open');
  }

  function collectFieldsFromUI(){
    const p = getCurrentProject();
    const base = (p && p.fields) ? {...p.fields} : defaultFields();

    // âœ… åŒã˜ data-field ãŒè¤‡æ•°ã‚ã‚‹ã®ã§ã€Œæœ€å¾Œã«è§¦ã£ãŸå€¤ã€ã‚’å„ªå…ˆã—ã¤ã¤ã€ç©ºã§ä¸Šæ›¸ãã—ãªã„
    document.querySelectorAll('[data-field]').forEach(el=>{
      const k = el.dataset.field;
      const v = el.value || "";
      if(v !== "" || (base[k] ?? "") === "") base[k] = v;
    });
    return base;
  }

  function setFieldsToUI(fields){
    document.querySelectorAll('[data-field]').forEach(el=>{
      el.value = fields?.[el.dataset.field] || "";
    });
  }

  // âœ… å…¥åŠ›ã®åŒæœŸï¼šåŒã˜ data-field ã‚’å…¨UIã¸åæ˜ 
  function syncSameFieldToAll(sourceEl){
    const key = sourceEl?.dataset?.field;
    if(!key) return;
    const val = sourceEl.value || "";
    document.querySelectorAll(`[data-field="${key}"]`).forEach(el=>{
      if(el !== sourceEl) el.value = val;
    });
  }

  // å…¥åŠ›å¤‰æ›´ã§å³ä¿å­˜ï¼ˆè»½ãï¼‰ï¼‹åŒä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŒæœŸ
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.matches('[data-field]')){
      syncSameFieldToAll(e.target);
      saveEditorData();
    }
  });

  /* -------------------------
     Plan font size control
  ------------------------- */
  function setPlanFontSize(size, shouldSave=true){
    const fs = Math.max(9, Math.min(14, parseInt(size,10) || 11));
    document.documentElement.style.setProperty('--planFont', fs + 'px');
    const range = document.getElementById('plan-font-range');
    const label = document.getElementById('plan-font-val');
    if(range) range.value = String(fs);
    if(label) label.innerText = fs + 'px';

    const p = getCurrentProject();
    if(p){
      ensureProjectDefaults(p);
      p.planSettings.fontSize = fs;
      if(shouldSave) saveEditorData();
    }
  }

  /* â˜…è¿½åŠ ï¼šè¡Œé–“åˆ¶å¾¡ï¼ˆA4ãƒ•ã‚£ãƒƒãƒˆã§ä½¿ç”¨ï¼‰ */
  function setPlanLineHeight(v, shouldSave=true){
    const lh = Math.max(1.2, Math.min(1.65, parseFloat(v) || 1.45));
    document.documentElement.style.setProperty('--planLine', String(lh));

    const p = getCurrentProject();
    if(p){
      ensureProjectDefaults(p);
      p.planSettings.lineHeight = lh;
      if(shouldSave) saveEditorData();
    }
  }

  const planFontRange = document.getElementById('plan-font-range');
  if(planFontRange){
    planFontRange.addEventListener('input', ()=>{
      setPlanFontSize(planFontRange.value, false);
    });
    planFontRange.addEventListener('change', ()=>{
      setPlanFontSize(planFontRange.value, true);
      if(isPlanOverflow()) fitPlanToA4({silent:true});
      toast();
    });
  }

  /* -------------------------
     Plan images (add / delete / replace / resize / box size)
  ------------------------- */
  let planImagePickMode = { mode: "append", index: -1 };

  function openPlanImagePicker(){
    planImagePickMode = { mode: "append", index: -1 };
    const inp = document.getElementById('plan-image-input');
    if(!inp) return;
    inp.value = "";
    inp.click();
  }

  function openPlanImageReplacePicker(index){
    planImagePickMode = { mode: "replace", index: index };
    const inp = document.getElementById('plan-image-input');
    if(!inp) return;
    inp.value = "";
    inp.click();
  }

  const planImgInput = document.getElementById('plan-image-input');
  if(planImgInput){
    planImgInput.addEventListener('change', async ()=>{
      const p = getCurrentProject();
      if(!p) return;
      ensureProjectDefaults(p);

      const files = Array.from(planImgInput.files || []);
      if(files.length === 0) return;

      if(planImagePickMode.mode === "replace" && planImagePickMode.index >= 0){
        const idx = planImagePickMode.index;
        const file = files[0];
        const src = await fileToDataURL(file);
        if(!src) return;

        // ç½®æ›ï¼ˆscale/boxHã¯ç¶­æŒï¼‰
        const old = p.planSettings.images[idx] || { src:"", scale:100, boxH:120 };
        p.planSettings.images[idx] = { src, scale: old.scale ?? 100, boxH: old.boxH ?? 120 };

      }else{
        // è¿½åŠ ï¼ˆç©ºã„ã¦ã„ã‚‹æ ã¸è©°ã‚ã‚‹ã€æœ€å¤§2ï¼‰
        const slots = p.planSettings.images || [];
        const canAdd = Math.max(0, 2 - slots.length);
        const addFiles = files.slice(0, canAdd);

        for(const f of addFiles){
          const src = await fileToDataURL(f);
          if(src) slots.push({ src, scale: 100, boxH: 120 });
        }
        p.planSettings.images = slots.slice(0,2);
      }

      updatePlanImagesSlot();
      saveEditorData();

      // â˜…è¿½åŠ ï¼šæº¢ã‚ŒãŸã‚‰è‡ªå‹•ã§A4ã«åã‚ã‚‹ï¼ˆä¼ç”»æ›¸ãŒè¡¨ç¤ºä¸­ã®ã¨ãã ã‘åˆ¤å®šï¼‰
      if(isPlanOverflow()) fitPlanToA4({silent:true});

      toast();
    });
  }

  function fileToDataURL(file){
    return new Promise((resolve)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = ()=> resolve("");
      reader.readAsDataURL(file);
    });
  }

  function deletePlanImage(index){
    const p = getCurrentProject();
    if(!p) return;
    ensureProjectDefaults(p);
    p.planSettings.images = (p.planSettings.images || []).filter((_,i)=> i !== index);
    updatePlanImagesSlot();
    saveEditorData();
    if(isPlanOverflow()) fitPlanToA4({silent:true});
    toast();
  }

  function setPlanImageScale(index, scale){
    const p = getCurrentProject();
    if(!p) return;
    ensureProjectDefaults(p);
    const sc = Math.max(50, Math.min(160, parseInt(scale,10) || 100));
    if(!p.planSettings.images[index]) return;
    p.planSettings.images[index].scale = sc;
    updatePlanImagesSlot(false); // å†æç”»ï¼ˆä¿å­˜ã¯å‘¼ã³å‡ºã—å…ƒã§ï¼‰
  }

  /* â˜…è¿½åŠ ï¼šç”»åƒæ ï¼ˆå æœ‰ã‚µã‚¤ã‚ºï¼‰ã®é«˜ã•ã‚’å¤‰æ›´ */
  function setPlanImageBoxH(index, h){
    const p = getCurrentProject();
    if(!p) return;
    ensureProjectDefaults(p);

    const bh = Math.max(80, Math.min(260, parseInt(h,10) || 120));
    if(!p.planSettings.images[index]) return;
    p.planSettings.images[index].boxH = bh;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°ã‚‚æ›´æ–°ï¼ˆä½“æ„Ÿå®‰å®šç”¨ï¼‰
    document.documentElement.style.setProperty('--planImgBoxH', bh + 'px');
    updatePlanImagesSlot(false);
  }

  function updatePlanImagesSlot(shouldSave=false){
    const p = getCurrentProject();
    if(!p) return;
    ensureProjectDefaults(p);

    const slot = document.getElementById('plan-image-slot');
    if(!slot) return;

    const imgs = (p.planSettings?.images || []).slice(0,2);

    const boxes = [0,1].map(i=>{
      const im = imgs[i];
      if(im && im.src){
        const sc = Math.max(50, Math.min(160, parseInt(im.scale,10) || 100));
        const bh = Math.max(80, Math.min(260, parseInt(im.boxH,10) || 120));
        return `
          <div class="imgbox" style="height:${bh}px;">
            <img alt="plan image ${i+1}" src="${im.src}" style="transform: scale(${sc/100});">
            <div class="img-tools no-print">
              <div class="row">
                <span class="lbl">ç”»åƒ${i+1}</span>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                  <button class="btn-mini" onclick="openPlanImageReplacePicker(${i})">å·®ã—æ›¿ãˆ</button>
                  <button class="btn-mini danger" onclick="deletePlanImage(${i})">å‰Šé™¤</button>
                </div>
              </div>

              <div class="row">
                <span class="lbl">ç”»åƒã‚µã‚¤ã‚º</span>
                <input type="range" min="50" max="160" step="5" value="${sc}"
                  oninput="setPlanImageScale(${i}, this.value)"
                  onchange="saveEditorData(); if(isPlanOverflow()) fitPlanToA4({silent:true}); toast();">
                <span class="lbl">${sc}%</span>
              </div>

              <div class="row">
                <span class="lbl">æ é«˜ã•</span>
                <input type="range" min="80" max="260" step="10" value="${bh}"
                  oninput="setPlanImageBoxH(${i}, this.value)"
                  onchange="saveEditorData(); if(isPlanOverflow()) fitPlanToA4({silent:true}); toast();">
                <span class="lbl">${bh}px</span>
              </div>
            </div>
          </div>
        `;
      }

      // ç©ºæ ï¼šè¿½åŠ ãƒœã‚¿ãƒ³
      return `
        <div class="imgbox" style="flex-direction:column; gap:10px; color:#94a3b8; font-size:11px; font-weight:900;">
          ç”»åƒ${i+1}ï¼ˆæœªè¨­å®šï¼‰
          <button class="btn-mini no-print" onclick="openPlanImagePicker()">ï¼‹ è¿½åŠ </button>
        </div>
      `;
    }).join("");

    slot.innerHTML = `<div class="plan-images">${boxes}</div>`;
    if(shouldSave) saveEditorData();
  }

  /* -------------------------
     â˜…A4 Fitï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¤å®š & è‡ªå‹•èª¿æ•´ï¼‰
  ------------------------- */
  function isPlanOverflow(){
    const page = document.getElementById('tab-plan');
    if(!page) return false;
    // è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ï¼ˆdisplay:noneï¼‰ã§ã¯åˆ¤å®šã—ãªã„
    if(page.offsetParent === null) return false;
    return page.scrollHeight > (page.clientHeight + 2);
  }

  function fitPlanToA4({silent=false} = {}){
    const p = getCurrentProject();
    if(!p) return;
    ensureProjectDefaults(p);

    // ä¼ç”»æ›¸ãŒè¦‹ãˆã¦ã„ãªã„ãªã‚‰ã€ç„¡ç†ã«åˆ¤å®šã—ãªã„ï¼ˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã¯é€šå¸¸è¡¨ç¤ºä¸­ï¼‰
    const plan = document.getElementById('tab-plan');
    if(!plan || plan.offsetParent === null){
      if(!silent) alert("ä¼ç”»æ›¸ã‚¿ãƒ–ã‚’é–‹ã„ãŸçŠ¶æ…‹ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    // ç¾åœ¨ã®UIå€¤ã‚’åæ˜ 
    const range = document.getElementById('plan-font-range');
    if(range){
      const fs = parseInt(range.value,10);
      if(Number.isFinite(fs)) p.planSettings.fontSize = fs;
    }

    let fs = p.planSettings.fontSize ?? 11;
    let lh = p.planSettings.lineHeight ?? 1.45;

    const minFont = 9;
    const minLine = 1.2;
    const minBoxH = 80;

    setPlanFontSize(fs, false);
    setPlanLineHeight(lh, false);
    updatePlanImagesSlot(false);

    let guard = 0;
    while(isPlanOverflow() && guard < 80){
      guard++;

      // 1) ç”»åƒæ ã‚’ç¸®ã‚ã‚‹ï¼ˆå„ªå…ˆï¼‰
      let changed = false;
      if(Array.isArray(p.planSettings.images)){
        for(const im of p.planSettings.images){
          if(im && Number.isFinite(im.boxH) && im.boxH > minBoxH){
            im.boxH = Math.max(minBoxH, im.boxH - 10);
            changed = true;
          }
        }
        if(changed){
          updatePlanImagesSlot(false);
          continue;
        }
      }

      // 2) æ–‡å­—ã‚’ç¸®ã‚ã‚‹
      if(fs > minFont){
        fs -= 1;
        p.planSettings.fontSize = fs;
        setPlanFontSize(fs, false);
        continue;
      }

      // 3) è¡Œé–“ã‚’è©°ã‚ã‚‹ï¼ˆæœ€å¾Œï¼‰
      if(lh > minLine){
        lh = Math.max(minLine, Math.round((lh - 0.05) * 100) / 100);
        p.planSettings.lineHeight = lh;
        setPlanLineHeight(lh, false);
        continue;
      }

      break;
    }

    saveEditorData();
    if(!silent) toast();
  }

  /* -------------------------
     Plan doc rendering
  ------------------------- */
  function fillPlanText(t, f){
    let s = t;

    if(s.includes("ä½œæˆæ—¥ï¼š")) s = s.replace("ä½œæˆæ—¥ï¼š20XXå¹´XXæœˆXXæ—¥", "ä½œæˆæ—¥ï¼š" + (f.createdDate || "20XXå¹´XXæœˆXXæ—¥"));
    s = s.replace("ï¼ˆä¼æ¥­åï¼‰", f.companyName || "ï¼ˆä¼æ¥­åï¼‰");
    s = s.replace("ï¼ˆéƒ¨ç½²åï¼‰", f.department || "ï¼ˆéƒ¨ç½²åï¼‰");

    if(s.trim() === "ã”æ‹…å½“è€…æ§˜" && f.contactName){
      s = f.contactName + " æ§˜";
    }

    s = s.replace("æ‰€å±ï¼šï¼ˆå­¦æ ¡åï¼‰ï¼ˆå­¦å¹´ï¼‰", "æ‰€å±ï¼š" + (f.schoolName || "ï¼ˆå­¦æ ¡åï¼‰") + (f.grade ? "ï¼ˆ" + f.grade + "ï¼‰" : "ï¼ˆå­¦å¹´ï¼‰"));

    if(s.startsWith("ç”Ÿå¾’ä»£è¡¨ï¼š")){
      s = "ç”Ÿå¾’ä»£è¡¨ï¼š" + (f.studentRep || "ã€€ã€€ã€€ã€€ã€€");
    }
    if(s.startsWith("æ‹…å½“æ•™å“¡ï¼š")){
      s = "æ‹…å½“æ•™å“¡ï¼š" + (f.teacherRep || "ã€€ã€€ã€€ã€€ã€€");
    }

    s = s.replace("ç§ãŸã¡ã¯ï¼ˆå­¦æ ¡åï¼‰ã®æ¢ç©¶å­¦ç¿’", "ç§ãŸã¡ã¯" + (f.schoolName || "ï¼ˆå­¦æ ¡åï¼‰") + "ã®æ¢ç©¶å­¦ç¿’");
    s = s.replace("ï¼ˆãƒ†ãƒ¼ãƒï¼šã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼‰", "ï¼ˆãƒ†ãƒ¼ãƒï¼š" + (f.theme || "ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€") + "ï¼‰");

    if(s.includes("å€™è£œæ—¥æ™‚ï¼š")){
      const d1 = f.dt1 || "ã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œ";
      const d2 = f.dt2 || "ã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œ";
      const d3 = f.dt3 || "ã€€æœˆã€€æ—¥ã€€ã€€æ™‚ã€œ";
      s = "å€™è£œæ—¥æ™‚ï¼š\nç¬¬1å¸Œæœ›ï¼ˆ" + d1 + "ï¼‰ï¼ç¬¬2å¸Œæœ›ï¼ˆ" + d2 + "ï¼‰ï¼ç¬¬3å¸Œæœ›ï¼ˆ" + d3 + "ï¼‰";
    }

    if(s.startsWith("å‚åŠ è€…ï¼š")){
      const sc = f.studentsCount || "ã€€";
      const tc = f.teachersCount || "ã€€";
      s = `å‚åŠ è€…ï¼šç”Ÿå¾’ï¼ˆ${sc}åï¼‰ï¼‹æ•™å“¡ï¼ˆ${tc}åï¼‰`;
    }
    if(s.startsWith("å ´æ‰€ï¼š")){
      s = "å ´æ‰€ï¼š" + (f.place || "ï¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³");
    }

    if(s.includes("ãƒ¡ãƒ¼ãƒ«ï¼šï¼ˆã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼‰")){
      const em = f.email || "ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€";
      const ph = f.phone || "ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€";
      s = `ãƒ¡ãƒ¼ãƒ«ï¼šï¼ˆ${em}ï¼‰\né›»è©±ï¼šï¼ˆ${ph}ï¼‰`;
    }

    return s;
  }

  const PLAN_HEADINGS = new Set([
    "è¬è¾","å–æã®ç›®çš„","å–ææ¦‚è¦ï¼ˆå¸Œæœ›ï¼‰","å†…å®¹èª¬æ˜",
    "ãŠä¼ºã„ã—ãŸã„å†…å®¹ï¼ˆä¾‹ï¼‰","è³‡æ–™ã‚„å†™çœŸã«ã¤ã„ã¦","ã€é€£çµ¡å…ˆã€‘"
  ]);

  function formatPlanLine(raw){
    const t = (raw || "").trim();
    if(t === "") return { html:"", cls:"" };

    if(t === "å–æã®ãŠé¡˜ã„"){
      return { html: `<strong>${escapeHtml(t)}</strong>`, cls:"plan-title" };
    }

    if(PLAN_HEADINGS.has(t)){
      return { html: `<strong>${escapeHtml(t)}</strong>`, cls:"plan-heading plan-bullet" };
    }

    const m = t.match(/^([^ï¼š]+)ï¼š(.*)$/);
    if(m){
      const label = m[1].trim();
      const rest  = m[2].trim();
      return { html: `<strong>${escapeHtml(label)}ï¼š</strong>${escapeHtml(rest)}`, cls:"plan-bullet" };
    }

    const bulletCandidates = [
      "è²´ç¤¾ã®äº‹æ¥­æ¦‚è¦","èª²é¡Œã«å¯¾ã™ã‚‹å–ã‚Šçµ„ã¿","æˆæœã¨é›£ã—ã•","ä»Šå¾Œã®å±•æœ›","ä¸­é«˜ç”Ÿã‚„åœ°åŸŸã«æœŸå¾…ã™ã‚‹ã“ã¨"
    ];
    if(bulletCandidates.some(k=> t.startsWith(k))){
      return { html: `ãƒ»${escapeHtml(t)}`, cls:"plan-bullet" };
    }

    return { html: escapeHtml(raw), cls:"" };
  }

  function renderPlanDoc(forceHtml){
    const p = getCurrentProject();
    const f = (p && p.fields) ? p.fields : collectFieldsFromUI();

    const area = document.getElementById('plan-doc-area');
    if(forceHtml){
      area.innerHTML = forceHtml;
      area.querySelectorAll('.doc-line[contenteditable="true"]').forEach(line=>{
        line.addEventListener('input', ()=> saveEditorData());
      });
      updatePlanImagesSlot();
      return;
    }

    setPlanFontSize(p?.planSettings?.fontSize ?? 11, false);
    setPlanLineHeight(p?.planSettings?.lineHeight ?? 1.45, false);

    area.innerHTML = PLAN_TEMPLATE.map((row, idx)=>{
      if(row.text === "__CONTENT_DESC_BLOCK__"){
        const desc = (f.planDescText || "ï¼ˆä¾‹ï¼‰å½“æ—¥ã¯ã€äº‹æ¥­æ¦‚è¦ãƒ»èª²é¡Œãƒ»å·¥å¤«ãƒ»ä»Šå¾Œã®å±•æœ›ã«ã¤ã„ã¦ä¼ºã„ã€æˆæ¥­æˆæœã¨ã—ã¦ç™ºè¡¨è³‡æ–™ã«ã¾ã¨ã‚ã¾ã™ã€‚");
        return `
          <div class="doc-line" contenteditable="true" data-doc="plan" data-idx="${idx}" style="text-align:left;">
            ${escapeHtml(desc)}
          </div>
          <div id="plan-image-slot" class="doc-line" style="text-align:left; padding-top:4px;"></div>
        `;
      }

      const txt = fillPlanText(row.text, f);
      const { html, cls } = formatPlanLine(txt);
      const safe = (html || "").replace(/\n/g, "<br>");
      return `<div class="doc-line ${cls}" contenteditable="true" data-doc="plan" data-idx="${idx}" style="text-align:${row.align};">${safe}</div>`;
    }).join("");

    area.querySelectorAll('.doc-line[contenteditable="true"]').forEach(line=>{
      line.addEventListener('input', ()=> saveEditorData());
    });

    updatePlanImagesSlot();
  }

  function regenPlan(silent){
    if(!silent){
      if(!confirm("å…¥åŠ›å†…å®¹ã§ä¼ç”»æ›¸ã‚’å†ç”Ÿæˆã—ã¾ã™ã€‚æœ¬æ–‡ã§æ‰‹ç›´ã—ã—ãŸå†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    }
    const p = getCurrentProject();
    if(!p) return;
    p.fields = collectFieldsFromUI();
    renderPlanDoc("");
    saveEditorData();
    if(isPlanOverflow()) fitPlanToA4({silent:true});
    if(!silent) toast();
  }

  /* -------------------------
     Presentation doc rendering
  ------------------------- */
  function renderPresDoc(forceHtml){
    const p = getCurrentProject();
    const f = (p && p.fields) ? p.fields : collectFieldsFromUI();
    const flow = Array.from(document.querySelectorAll('.flow-input')).map(el=> el.innerText);

    const area = document.getElementById('pres-doc-area');

    if(forceHtml){
      area.innerHTML = forceHtml;
      area.querySelectorAll('.doc-line[contenteditable="true"]').forEach(line=>{
        line.addEventListener('input', ()=> saveEditorData());
      });
      return;
    }

    const slots = [
      f.teamName || "",
      f.presTopic || flow[0] || "",
      f.theme || flow[2] || "",
      f.fieldAction1 || "ï¼ˆä¾‹ï¼šã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ï¼‰",
      f.insight1 || "ï¼ˆæ°—ã¥ãï¼‰",
      f.research2 || "ï¼ˆèª¿æŸ»ï¼‰",
      f.fact2 || "ï¼ˆäº‹å®Ÿï¼‰",
      f.coreProblem || flow[2] || "",
      f.hypCause || "",
      f.hypReason || "",
      f.hypSolution || "",
      f.ideaName || flow[3] || "",
      f.concept || "",
      f.feature1 || "",
      f.feature2 || "",
      f.verifyMethod || flow[4] || "",
      f.verifyStep1 || "",
      f.verifyCheck || "",
      f.doDate || "",
      f.doPlace || "",
      f.target || "",
      f.doWhat || "",
      f.data1 || "",
      f.learned || "",
      f.conclusion || "",
      f.discussion || "",
      "ï¼ˆèª²é¡Œï¼‰",
      f.nextNeed || "",
      (f.future || flow[5] || "") + "ã¨ã„ã†"
    ];
    let slotIdx = 0;

    const blocks = [];
    for(const line of PRES_RAW){
      if(line === "------------------------"){
        blocks.push({ type:"sep" });
        continue;
      }
      const isHeading = (line.length <= 6 && !line.includes("ã€‚") && !line.includes("ã€"));
      if(isHeading){
        blocks.push({ type:"heading", text: line });
      }else{
        let txt = line;
        while(txt.includes("ã€Œã€") && slotIdx < slots.length){
          txt = txt.replace("ã€Œã€", "ã€Œ" + (slots[slotIdx] || "") + "ã€");
          slotIdx++;
        }
        blocks.push({ type:"p", text: txt });
      }
    }

    area.innerHTML = blocks.map((b, i)=>{
      if(b.type==="sep"){
        return `<div class="doc-line" style="text-align:left; color:#9ca3af; font-weight:900;">------------------------</div>`;
      }
      if(b.type==="heading"){
        return `<div class="doc-line" contenteditable="true" data-doc="pres" data-idx="${i}" style="text-align:left; font-weight:1000;">${escapeHtml(b.text)}</div>`;
      }
      return `<div class="doc-line" contenteditable="true" data-doc="pres" data-idx="${i}" style="text-align:left;">${escapeHtml(b.text)}</div>`;
    }).join("");

    area.querySelectorAll('.doc-line[contenteditable="true"]').forEach(line=>{
      line.addEventListener('input', ()=> saveEditorData());
    });
  }

  function regenPres(silent){
    if(!silent){
      if(!confirm("å…¥åŠ›å†…å®¹ã§ãƒ—ãƒ¬ã‚¼ãƒ³å°æœ¬ã‚’å†ç”Ÿæˆã—ã¾ã™ã€‚æœ¬æ–‡ã§æ‰‹ç›´ã—ã—ãŸå†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    }
    const p = getCurrentProject();
    if(!p) return;
    p.fields = collectFieldsFromUI();
    renderPresDoc("");
    saveEditorData();
    if(!silent) toast();
  }

  /* -------------------------
     Video auto draftï¼ˆæ±ºã‚å°è©â†’1æ–‡ãšã¤èª¬æ˜â†’æ¬¡å›äºˆå‘Šï¼‰
  ------------------------- */
  function pick(...vals){
    return vals.find(v => (v||"").toString().trim() !== "") || "";
  }

  function buildEpisodeCuts(ep, ctx){
    const { flow, f, catchphrase } = ctx;

    const team = pick(f.teamName, "ï¼ˆãƒãƒ¼ãƒ åï¼‰");
    const goal = pick(flow[0], f.presTopic, "ï¼ˆç›®æ¨™ï¼‰");
    const place = pick(f.doPlace, "ï¼ˆå ´æ‰€ï¼‰");
    const theme = pick(f.theme, "ï¼ˆãƒ†ãƒ¼ãƒï¼‰");
    const problem = pick(f.coreProblem, "ï¼ˆèª²é¡Œï¼‰");
    const action1 = pick(f.fieldAction1, "ï¼ˆç¾å ´ã§ã‚„ã£ãŸã“ã¨ï¼‰");
    const idea = pick(f.ideaName, "ï¼ˆä½œæˆ¦ï¼‰");
    const concept = pick(f.concept, "");
    const next = pick(f.nextNeed, "ï¼ˆæ¬¡ã®å±•é–‹ï¼‰");

    const epLabel = `ç¬¬${ep}è©±`;

    const cp = (catchphrase || "").trim() || `ç§ãŸã¡ã¯ã€${goal}ã€${team}ã§ã™ï¼`;

    const cuts = [
      {
        text: cp,
        visual: `ãƒãƒ¼ãƒ å…¨å“¡ã§å®£è¨€ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ†ãƒ­ãƒƒãƒ—ï¼‹${epLabel}ï¼‰`
      },
      {
        text: `èˆå°ã¯${place}ã€ãƒ†ãƒ¼ãƒã¯ã€Œ${theme}ã€ã§ã™ã€‚`,
        visual: `å ´æ‰€ã®å…¨æ™¯ï¼ˆãƒ‰ãƒ­ãƒ¼ãƒ³/å¼•ãã®ç”»ï¼‰ï¼‹åœ°åãƒ†ãƒ­ãƒƒãƒ—`
      },
      {
        text: `ã§ã‚‚ä»Šã€${problem}ã¨ã„ã†å£ãŒã‚ã‚Šã¾ã™ã€‚`,
        visual: `å›°ã‚Šã”ã¨ãŒä¼ã‚ã‚‹ã‚«ãƒƒãƒˆï¼ˆé™ã‹ãªè¡—/è³‡æ–™/è¡¨æƒ…ï¼‰`
      },
      {
        text: `ã¾ãšç§ãŸã¡ã¯${action1}ã‹ã‚‰å§‹ã‚ã¾ã—ãŸã€‚`,
        visual: `ç¾å ´ã§å–æãƒ»èª¿æŸ»ã—ã¦ã„ã‚‹æ§˜å­`
      },
      {
        text: `ãã“ã§è¦‹ãˆãŸãƒªã‚¢ãƒ«ã‚’ã€1ã¤ãšã¤è¨€èªåŒ–ã—ã¾ã™ã€‚`,
        visual: `ãƒ¡ãƒ¢ãƒ»ä»˜ç®‹ãƒ»ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã§æ•´ç†ã™ã‚‹æ‰‹å…ƒ`
      },
      {
        text: `ãã—ã¦ä½œæˆ¦ã¯ã€Œ${idea}ã€ã§ã™ã€‚`,
        visual: `ä½œæˆ¦åãŒå‡ºã‚‹ã‚«ãƒƒãƒˆï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢å›³ãƒ»ç”»é¢ãƒ»ã‚¹ã‚±ãƒƒãƒï¼‰`
      },
      {
        text: concept ? `ä¸€è¨€ã§ã„ã†ã¨ã€Œ${concept}ã€ã§ã™ã€‚` : `ä¸€è¨€ã§ã„ã†ã¨ã€Œå°ã•ãè©¦ã—ã¦æ”¹å–„ã€ã§ã™ã€‚`,
        visual: `ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è±¡å¾´ã™ã‚‹çµµï¼ˆãƒ‡ãƒ¢/ãƒ—ãƒ­ãƒˆ/ä½“é¨“ï¼‰`
      },
      {
        text: `æ¬¡å›ã€Œ${next}ã€ã¸ï¼`,
        visual: `æ¬¡å›äºˆå‘Šï¼ˆå‘ã‹ã†èƒŒä¸­/ç§»å‹•/æ‰‰ãŒé–‹ãã‚«ãƒƒãƒˆï¼‰`
      },
    ];

    return cuts;
  }

  function autoDraftVideo(){
    const p = getCurrentProject();
    if(!p) return;
    const f = p.fields || collectFieldsFromUI();
    const flow = Array.from(document.querySelectorAll('.flow-input')).map(el=> el.innerText);

    const existingCatch = (p.videoCatchphrase || getCellText('ep1-c1') || "").trim();
    const ctx = { flow, f, catchphrase: existingCatch };

    const tbody = document.getElementById('video-script-tbody');

    for(let ep=1; ep<=6; ep++){
      const cuts = buildEpisodeCuts(ep, ctx);
      for(let cut=1; cut<=LINES_PER_EP; cut++){
        const tr = tbody.querySelector(`tr[data-rowid="ep${ep}-c${cut}"]`);
        if(!tr) continue;
        const tcell = tr.querySelector('[data-vs="text"]');
        const vcell = tr.querySelector('[data-vs="visual"]');
        const row = cuts[cut-1] || { text:"", visual:"" };

        // ç©ºæ¬„ã®ã¿åŸ‹ã‚ã‚‹ï¼ˆæ—¢å­˜ç·¨é›†ã¯å£Šã•ãªã„ï¼‰
        if(tcell && (tcell.innerText || "").trim() === "") tcell.innerText = row.text || "";
        if(vcell && (vcell.innerText || "").trim() === "") vcell.innerText = row.visual || "";
      }
    }

    // âœ… æ±ºã‚å°è©ã¯å…¨è©±ã¸åŒæœŸï¼ˆç©ºæ¬„ã§ã‚‚åŸ‹ã‚ã‚‹ï¼‰
    applyCatchphraseToAll(existingCatch || getCellText('ep1-c1'));

    saveEditorData();
    toast();
  }

  /* -------------------------
     âœ… Video catchphrase sync
     - ã©ã‚Œã‹ã®ã€Œå„è©±ã‚«ãƒƒãƒˆ1ï¼ˆc1ï¼‰ã€ã‚’ç·¨é›†ã™ã‚‹ã¨å…¨è©±ã®c1ã¸åŒæœŸ
  ------------------------- */
  function getCellText(rowid){
    const tr = document.querySelector(`#video-script-tbody tr[data-rowid="${rowid}"]`);
    const td = tr?.querySelector('[data-vs="text"]');
    return td ? td.innerText : "";
  }

  function setCellText(rowid, text){
    const tr = document.querySelector(`#video-script-tbody tr[data-rowid="${rowid}"]`);
    const td = tr?.querySelector('[data-vs="text"]');
    if(td) td.innerText = text || "";
  }

  function applyCatchphraseToAll(text){
    const cp = (text || "").toString();
    for(let ep=1; ep<=6; ep++){
      setCellText(`ep${ep}-c1`, cp);
    }
    const p = getCurrentProject();
    if(p){
      p.videoCatchphrase = cp.trim();
    }
  }

  // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§åŒæœŸï¼ˆvideo tableï¼‰
  document.getElementById('video-script-tbody').addEventListener('input', (e)=>{
    const td = e.target;
    if(!td || td.getAttribute('data-vs') !== 'text') return;
    const tr = td.closest('tr');
    if(!tr) return;

    // ã‚«ãƒƒãƒˆ1ã ã‘åŒæœŸ
    const rowid = tr.dataset.rowid || "";
    if(rowid.endsWith('-c1')){
      const cp = td.innerText || "";
      applyCatchphraseToAll(cp);
      saveEditorData();
    }else{
      saveEditorData();
    }
  });

  /* -------------------------
     Bubble logic
  ------------------------- */
  function organizePolygon(parentId){
    const pb = document.getElementById(parentId);
    const children = Array.from(pb.querySelectorAll('.child-container'));
    const total = children.length; if(total===0) return;
    const centerX = pb.offsetWidth/2 - 27;
    const centerY = pb.offsetHeight/2 - 27;
    const radius = total === 1 ? 0 : 45;
    children.forEach((child, i)=>{
      const angle = (i * 2 * Math.PI / total) - (Math.PI / 2);
      child.style.left = (centerX + radius * Math.cos(angle)) + 'px';
      child.style.top  = (centerY + radius * Math.sin(angle)) + 'px';
    });
  }

  function createChildDOM(label, text="", size=55, x=0, y=0){
    const container = document.createElement('div');
    container.className = 'child-container';
    container.innerHTML = `
      <div class="child-label-wrap">
        <div class="child-label" contenteditable="true">${escapeHtml(label)}</div>
        <button class="child-del-btn no-print" onclick="deleteChildBubble(this)">Ã—</button>
      </div>
      <div class="child-bubble" style="width:${size}px; height:${size}px;" data-size="${size}">
        <input class="child-text" value="${escapeAttr(text)}">
        <div class="resize-handle"></div>
      </div>
    `;
    container.style.left = x + 'px';
    container.style.top  = y + 'px';

    container.oncontextmenu = (e)=>{ e.preventDefault(); deleteChildBubble(container.querySelector('.child-del-btn')); };

    const startAction = (e)=>{
      const coords = getClientCoords(e);
      if(e.target.classList.contains('resize-handle')){
        resizeElem = container.querySelector('.child-bubble');
        e.stopPropagation();
        return;
      }
      if(e.target.hasAttribute('contenteditable') || e.target.tagName === 'INPUT' || e.target.classList.contains('child-del-btn')) return;
      activeElem = container; e.stopPropagation();
      const r = container.getBoundingClientRect();
      offset.x = coords.x - r.left; offset.y = coords.y - r.top;
      container.style.transition = 'none';
    };
    container.onmousedown = startAction;
    container.ontouchstart = startAction;

    const labelEl = container.querySelector('.child-label');
    const textEl  = container.querySelector('.child-text');
    labelEl.addEventListener('input', ()=> saveEditorData());
    textEl.addEventListener('input', ()=> saveEditorData());

    return container;
  }

  function deleteChildBubble(btn){
    const container = btn.closest('.child-container');
    const parentId = container.parentElement.id;
    container.remove();
    if(parentId) organizePolygon(parentId);
    saveEditorData();
  }

  function smartAdd(parentId){
    const pb = document.getElementById(parentId);
    const existingLabels = Array.from(pb.querySelectorAll('.child-label')).map(el=> el.innerText);
    const label = masterConfig[parentId].find(l=> !existingLabels.includes(l)) || 'æ–°è¦';
    pb.appendChild(createChildDOM(label, "", 55, 50, 50));
    organizePolygon(parentId);
    saveEditorData();
  }

  const globalStart = (e)=>{
    const coords = getClientCoords(e);
    if(e.target.classList.contains('resize-handle')){
      resizeElem = e.target.parentElement;
      e.stopPropagation(); return;
    }
    const pb = e.target.closest('.parent-bubble');
    if(pb && !e.target.classList.contains('quick-add-btn')){
      activeElem = pb;
      const r = pb.getBoundingClientRect();
      offset.x = coords.x - r.left;
      offset.y = coords.y - r.top;
    }
  };
  document.onmousedown = globalStart;
  document.ontouchstart = globalStart;

  const globalMove = (e)=>{
    if(!activeElem && !resizeElem) return;
    const coords = getClientCoords(e);
    if(resizeElem){
      const r = resizeElem.getBoundingClientRect();
      const newSize = Math.max(40, coords.x - r.left);
      resizeElem.style.width = resizeElem.style.height = newSize + 'px';
      if(resizeElem.classList && resizeElem.classList.contains('child-bubble')){
        resizeElem.dataset.size = String(Math.round(newSize));
      }
      e.preventDefault();
      return;
    }
    const canvas = document.getElementById('canvas').getBoundingClientRect();
    if(activeElem.classList.contains('child-container')){
      const p = activeElem.parentElement.getBoundingClientRect();
      activeElem.style.left = (coords.x - p.left - offset.x) + 'px';
      activeElem.style.top  = (coords.y - p.top  - offset.y) + 'px';
    }else{
      activeElem.style.left = (coords.x - canvas.left - offset.x) + 'px';
      activeElem.style.top  = (coords.y - canvas.top  - offset.y) + 'px';
    }
    e.preventDefault();
  };
  document.onmousemove = globalMove;
  document.ontouchmove = globalMove;

  document.onmouseup = document.ontouchend = ()=>{
    if(activeElem || resizeElem) saveEditorData();
    activeElem = null; resizeElem = null;
  };

  /* -------------------------
     HTML escape
  ------------------------- */
  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHtml(str).replaceAll("\n"," ");
  }

  /* -------------------------
     Initial load
  ------------------------- */
  window.onload = ()=>{
    if(data.folders.length === 0) createNewFolder();
    renderDashboard();
    setPlanFontSize(11, false);
    setPlanLineHeight(1.45, false);
  };
</script>
</body>
</html>
